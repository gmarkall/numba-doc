<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>5.6. Notes on Numba Runtime &mdash; Numba 0.19.1-py2.7-macosx-10.5-x86_64.egg documentation</title>
    <meta name="description" content="">
    <meta name="author" content="">

    

<link rel="stylesheet" href="../_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" id="current-theme" href="../_static/css/bootstrap3/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" id="current-adjust-theme" type="text/css" />

<link rel="stylesheet" href="../_static/css/font-awesome.min.css">

<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
}
</style>

<link rel="stylesheet" href="../_static/css/basicstrap.css" type="text/css" />
<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../',
            VERSION:     '0.19.1-py2.7-macosx-10.5-x86_64.egg',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
    <script type="text/javascript" src="../_static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/bootstrap3.min.js"></script>
<script type="text/javascript" src="../_static/js/jquery.cookie.min.js"></script>
<script type="text/javascript" src="../_static/js/basicstrap.js"></script>
<script type="text/javascript">
</script>
    <link rel="top" title="Numba 0.19.1-py2.7-macosx-10.5-x86_64.egg documentation" href="../index.html" />
    <link rel="up" title="5. Developer Manual" href="index.html" />
    <link rel="next" title="5.7. Using the Numba Rewrite Pass for Fun and Optimization" href="rewrites.html" />
    <link rel="prev" title="5.5. Notes on generators" href="generators.html" /> 
  </head>
  <body role="document">
    <div id="navbar-top" class="navbar navbar-fixed-top navbar-default" role="navigation" aria-label="top navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Numba 0.19.1-py2.7-macosx-10.5-x86_64.egg documentation</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
              <li class="dropdown visible-xs">
                <a role="button" id="localToc" data-toggle="dropdown" data-target="#" href="#">Table Of Contents <b class="caret"></b></a>
                <ul class="dropdown-menu localtoc sp-localtoc" role="menu" aria-labelledby="localToc">
                <ul>
<li><a class="reference internal" href="#">5.6. Notes on Numba Runtime</a><ul>
<li><a class="reference internal" href="#memory-management">5.6.1. Memory Management</a><ul>
<li><a class="reference internal" href="#cooperating-with-cpython">5.6.1.1. Cooperating with CPython</a></li>
<li><a class="reference internal" href="#compiler-side-cooperation">5.6.1.2. Compiler-side Cooperation</a></li>
<li><a class="reference internal" href="#optimizations">5.6.1.3. Optimizations</a></li>
<li><a class="reference internal" href="#quirks">5.6.1.4. Quirks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#future-plan">5.6.2. Future Plan</a></li>
</ul>
</li>
</ul>

                </ul>
              </li>

            
              <li><a href="generators.html" title="5.5. Notes on generators" accesskey="P">previous </a></li>
              <li><a href="rewrites.html" title="5.7. Using the Numba Rewrite Pass for Fun and Optimization" accesskey="N">next </a></li>
              <li><a href="../genindex.html" title="General Index" accesskey="I">index </a></li>
              <li><a href="index.html" accesskey="U">5. Developer Manual</a></li>
            
            <li class="visible-xs"><a href="../_sources/developer/numba-runtime.txt" rel="nofollow">Show Source</a></li>

            <li class="visible-xs">
                <form class="search form-search form-inline navbar-form navbar-right sp-searchbox" action="../search.html" method="get">
                  <div class="input-append input-group">
                    <input type="text" class="search-query form-control" name="q" placeholder="Search...">
                    <span class="input-group-btn">
                    <input type="submit" class="btn" value="Go" />
                    </span>
                  </div>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </li>
          </ul>
        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">

      <!-- row -->
      <div class="row">
         
<div class="col-md-3 hidden-xs">
  <div class="sidebar hidden-xs" role="navigation" aria-label="main navigation">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.6. Notes on Numba Runtime</a><ul>
<li><a class="reference internal" href="#memory-management">5.6.1. Memory Management</a><ul>
<li><a class="reference internal" href="#cooperating-with-cpython">5.6.1.1. Cooperating with CPython</a></li>
<li><a class="reference internal" href="#compiler-side-cooperation">5.6.1.2. Compiler-side Cooperation</a></li>
<li><a class="reference internal" href="#optimizations">5.6.1.3. Optimizations</a></li>
<li><a class="reference internal" href="#quirks">5.6.1.4. Quirks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#future-plan">5.6.2. Future Plan</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="generators.html"
                        title="previous chapter">5.5. Notes on generators</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="rewrites.html"
                        title="next chapter">5.7. Using the Numba Rewrite Pass for Fun and Optimization</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/developer/numba-runtime.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" role="search">
  <h3>Quick search</h3>
  <form class="search form-inline" action="../search.html" method="get">
      <div class="input-append input-group">
        <input type="text" class="search-query form-control" name="q" placeholder="Search...">
        <span class="input-group-btn">
        <input type="submit" class="btn" value="Go" />
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div> 
        

        <div class="col-md-9">
          <div class="document" role="main">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <div class="section" id="notes-on-numba-runtime">
<span id="arch-numba-runtime"></span><h1>5.6. Notes on Numba Runtime<a class="headerlink" href="#notes-on-numba-runtime" title="Permalink to this headline">¶</a></h1>
<p>The <em>Numba Runtime (NRT)</em> provides the language runtime to the <em>nopython mode</em>
Python subset.  NRT is a standalone C library with a Python binding.  This
allows NPM runtime feature to be used without the GIL.  Currently, the only
language feature implemented in NRT is memory management.</p>
<div class="section" id="memory-management">
<h2>5.6.1. Memory Management<a class="headerlink" href="#memory-management" title="Permalink to this headline">¶</a></h2>
<p>NRT implements memory management for NPM code.  It uses <em>atomic reference count</em>
for threadsafe, deterministic memory management.  NRT maintains a separate
<tt class="docutils literal"><span class="pre">MemInfo</span></tt> structure for storing information about each allocation.</p>
<div class="section" id="cooperating-with-cpython">
<h3>5.6.1.1. Cooperating with CPython<a class="headerlink" href="#cooperating-with-cpython" title="Permalink to this headline">¶</a></h3>
<p>For NRT to cooperate with CPython, the NRT python binding provides adaptors for
converting python objects that export a memory region.  When such an
object is used as an argument to a NPM function, a new <tt class="docutils literal"><span class="pre">MemInfo</span></tt> is created
and it acquires a reference to the Python object.  When a NPM value is returned
to the Python interpreter, the associated <tt class="docutils literal"><span class="pre">MemInfo</span></tt> (if any) is checked.  If
the <tt class="docutils literal"><span class="pre">MemInfo</span></tt> references a Python object, the underlying Python object is
released and returned instead.  Otherwise, the <tt class="docutils literal"><span class="pre">MemInfo</span></tt> is wrapped in a
Python object and returned.  Additional process maybe required depending on
the type.</p>
<p>The current implementation supports Numpy array and any buffer-exporting types.</p>
</div>
<div class="section" id="compiler-side-cooperation">
<h3>5.6.1.2. Compiler-side Cooperation<a class="headerlink" href="#compiler-side-cooperation" title="Permalink to this headline">¶</a></h3>
<p>NRT reference counting requires the compiler to emit incref/decref operations
according to the usage.  When the reference count drops to zero, the compiler
must call the destructor routine in NRT.</p>
</div>
<div class="section" id="optimizations">
<span id="nrt-refct-opt-pass"></span><h3>5.6.1.3. Optimizations<a class="headerlink" href="#optimizations" title="Permalink to this headline">¶</a></h3>
<p>The compiler is allowed to emit incref/decref operations naively.  It relies
on an optimization pass that to remove the redundant reference count
operations.</p>
<p>The optimization pass runs on block level to avoid control flow analysis.
It depends on LLVM function optimization pass to simplify the control flow,
stack-to-register, and simplify instructions.  It works by matching and
removing incref and decref pairs within each block.</p>
</div>
<div class="section" id="quirks">
<h3>5.6.1.4. Quirks<a class="headerlink" href="#quirks" title="Permalink to this headline">¶</a></h3>
<p>All NRT routines currently initializes refcount to 0, because the compiler
relies on variable binding for doing incref/decref.  Every value is bound to
a variable in the Numba IR.</p>
<p>Since the <a class="reference internal" href="#nrt-refct-opt-pass">refcount optimization pass</a> requires LLVM
function optimization pass, the pass works on the LLVM IR as text.  The
optimized IR is then materialized again as a new LLVM in-memory bitcode object.</p>
</div>
</div>
<div class="section" id="future-plan">
<h2>5.6.2. Future Plan<a class="headerlink" href="#future-plan" title="Permalink to this headline">¶</a></h2>
<p>The plan for NRT is to make a standalone shared library that can be linked to
Numba compiled code, including use within the Python interpreter and without
the Python interpreter.  To make that work, we will be doing some refactoring:</p>
<ul class="simple">
<li>numba NPM code references statically compiled code in &#8220;helperlib.c&#8221;.  Those
functions should be moved to NRT.</li>
</ul>
</div>
</div>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row footer-relbar">
<div id="navbar-related" class=" related navbar navbar-default" role="navigation" aria-label="related navigation">
  <div class="navbar-inner">
    <ul class="nav navbar-nav">
        <li><a href="../index.html">Numba 0.19.1-py2.7-macosx-10.5-x86_64.egg documentation</a></li>
    </ul>
    <ul class="nav navbar-nav pull-right hidden-xs hidden-sm">
      
        <li><a href="generators.html" title="5.5. Notes on generators" >previous</a></li>
        <li><a href="rewrites.html" title="5.7. Using the Numba Rewrite Pass for Fun and Optimization" >next</a></li>
        <li><a href="../genindex.html" title="General Index" >index</a></li>
        <li><a href="index.html" >5. Developer Manual</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer role="contentinfo">
          &copy; Copyright 2012-2015, Continuum Analytics.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>