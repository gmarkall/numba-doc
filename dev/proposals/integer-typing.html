<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>7.1.1. NBEP 1: Changes in integer typing &mdash; Numba 0.23.1+121.g4e7f360-py2.7-linux-x86_64.egg documentation</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
<link rel="stylesheet" href="../_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/font-awesome.min.css">
<!--[if IE 7]>
<link rel="stylesheet" href="../_static/css/font-awesome-ie7.min.css">
<![endif]-->
<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
}
</style>
<link rel="stylesheet" href="../_static/basicstrap.css" type="text/css" />
<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/bootstrap-responsive.min.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../',
            VERSION:     '0.23.1+121.g4e7f360-py2.7-linux-x86_64.egg',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="../_static/js/jquery.min.js"></script>
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    $('.show-sidebar').click(function(e) {
       e.preventDefault();
       if ($(".show-sidebar").html() == "Open Table Of Contents") {
          $('.for-mobile').removeClass('hidden-phone');
          $(".show-sidebar").html("Close Table Of Contents");
       } else {
          $(".show-sidebar").html("Open Table Of Contents");
       }
    });
  });
</script>
    <link rel="top" title="Numba 0.23.1+121.g4e7f360-py2.7-linux-x86_64.egg documentation" href="../index.html" />
    <link rel="up" title="7. Numba Enhancement Proposals" href="index.html" />
    <link rel="next" title="7.2.1. NBEP 2: Extension points" href="extension-points.html" />
    <link rel="prev" title="7. Numba Enhancement Proposals" href="index.html" /> 
  </head>
  <body>
    <div class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../index.html">Numba 0.23.1+121.g4e7f360-py2.7-linux-x86_64.egg documentation</a>
          <div class="nav-collapse collapse">
            <ul class="nav pull-right">
              
                <li>
                <a href="../genindex.html" title="General Index" accesskey="I">index</a>
                </li>
                <li>
                <a href="extension-points.html" title="7.2.1. NBEP 2: Extension points" accesskey="N">next</a>
                </li>
                <li>
                <a href="index.html" title="7. Numba Enhancement Proposals" accesskey="P">previous</a>
                </li>
                <li>
                <a href="index.html" accesskey="U">7. Numba Enhancement Proposals</a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">


      
      <div class="row-fluid hidden-desktop hidden-tablet">
      
<div class="span3 ">
  <a class="visible-phone btn btn-small show-sidebar" data-toggle="collapse" data-target=".for-mobile">Open Table Of Contents</a>
  <div class="for-mobile sidebar hidden-phone">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.1.1. NBEP 1: Changes in integer typing</a><ul>
<li><a class="reference internal" href="#current-semantics">7.1.1.1. Current semantics</a></li>
<li><a class="reference internal" href="#proposal-predictable-width-conserving-typing">7.1.1.2. Proposal: predictable width-conserving typing</a></li>
<li><a class="reference internal" href="#proposal-impact">7.1.1.3. Proposal impact</a><ul>
<li><a class="reference internal" href="#semantics">7.1.1.3.1. Semantics</a></li>
<li><a class="reference internal" href="#performance">7.1.1.3.2. Performance</a></li>
<li><a class="reference internal" href="#implementation">7.1.1.3.3. Implementation</a></li>
<li><a class="reference internal" href="#limitations">7.1.1.3.4. Limitations</a></li>
<li><a class="reference internal" href="#long-term-horizon">7.1.1.3.5. Long-term horizon</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">7. Numba Enhancement Proposals</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="extension-points.html"
                        title="next chapter">7.2.1. NBEP 2: Extension points</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/proposals/integer-typing.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox">
  <h3>Quick search</h3>
  <form class="search form-search" action="../search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="Go" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div>
      </div>
      

      <!-- row -->
      <div class="row-fluid">
         
<div class="span3 visible-desktop visible-tablet">
  <div class=" sidebar hidden-phone">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.1.1. NBEP 1: Changes in integer typing</a><ul>
<li><a class="reference internal" href="#current-semantics">7.1.1.1. Current semantics</a></li>
<li><a class="reference internal" href="#proposal-predictable-width-conserving-typing">7.1.1.2. Proposal: predictable width-conserving typing</a></li>
<li><a class="reference internal" href="#proposal-impact">7.1.1.3. Proposal impact</a><ul>
<li><a class="reference internal" href="#semantics">7.1.1.3.1. Semantics</a></li>
<li><a class="reference internal" href="#performance">7.1.1.3.2. Performance</a></li>
<li><a class="reference internal" href="#implementation">7.1.1.3.3. Implementation</a></li>
<li><a class="reference internal" href="#limitations">7.1.1.3.4. Limitations</a></li>
<li><a class="reference internal" href="#long-term-horizon">7.1.1.3.5. Long-term horizon</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">7. Numba Enhancement Proposals</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="extension-points.html"
                        title="next chapter">7.2.1. NBEP 2: Extension points</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/proposals/integer-typing.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox">
  <h3>Quick search</h3>
  <form class="search form-search" action="../search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="Go" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div> 
        

        <div class="span9">
          <div class="document">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <div class="section" id="nbep-1-changes-in-integer-typing">
<h1>7.1.1. NBEP 1: Changes in integer typing<a class="headerlink" href="#nbep-1-changes-in-integer-typing" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Antoine Pitrou</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">July 2015</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
</tbody>
</table>
<div class="section" id="current-semantics">
<h2>7.1.1.1. Current semantics<a class="headerlink" href="#current-semantics" title="Permalink to this headline">¶</a></h2>
<p>Type inference of integers in Numba currently has some subtleties
and some corner cases.  The simple case is when some variable has an obvious
Numba type (for example because it is the result of a constructor call to a
Numpy scalar type such as <code class="docutils literal"><span class="pre">np.int64</span></code>). That case suffers no ambiguity.</p>
<p>The less simple case is when a variable doesn&#8217;t bear such explicit
information.  This can happen because it is inferred from a built-in Python
<code class="docutils literal"><span class="pre">int</span></code> value, or from an arithmetic operation between two integers, or
other cases yet.  Then Numba has a number of rules to infer the resulting
Numba type, especially its signedness and bitwidth.</p>
<p>Currently, the generic case could be summarized as: <em>start small,
grow bigger as required</em>.  Concretely:</p>
<ol class="arabic simple">
<li>Each constant or pseudo-constant is inferred using the <em>smallest signed
integer type</em> that can correctly represent it (or, possibly, <code class="docutils literal"><span class="pre">uint64</span></code>
for positive integers between <code class="docutils literal"><span class="pre">2**63</span></code> and <code class="docutils literal"><span class="pre">2**64</span> <span class="pre">-</span> <span class="pre">1</span></code>).</li>
<li>The result of an operation is typed so as to ensure safe representation
in the face of overflow and other magnitude increases (for example,
<code class="docutils literal"><span class="pre">int32</span> <span class="pre">+</span> <span class="pre">int32</span></code> would be typed <code class="docutils literal"><span class="pre">int64</span></code>).</li>
<li>As an exception, a Python <code class="docutils literal"><span class="pre">int</span></code> used as function argument is always
typed <code class="docutils literal"><span class="pre">intp</span></code>, a pointer-size integer.  This is to avoid the proliferation
of compiled specializations, as otherwise various integer bitwidths
in input arguments may produce multiple signatures.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The second rule above (the &#8220;respect magnitude increases&#8221; rule)
reproduces Numpy&#8217;s behaviour with arithmetic on scalar values.
Numba, however, has different implementation and performance constraints
than Numpy scalars.</p>
<p class="last">It is worth nothing, by the way, that Numpy arrays do not implement
said rule (i.e. <code class="docutils literal"><span class="pre">array(int32)</span> <span class="pre">+</span> <span class="pre">array(int32)</span></code> is typed <code class="docutils literal"><span class="pre">array(int32)</span></code>,
not <code class="docutils literal"><span class="pre">array(int64)</span></code>).  Probably because this makes performance more
controllable.</p>
</div>
<p>This has several non-obvious side-effects:</p>
<ol class="arabic">
<li><p class="first">It is difficult to predict the precise type of a value inside a function,
after several operations.  The basic operands in an expression tree
may for example be <code class="docutils literal"><span class="pre">int8</span></code> but the end result may be <code class="docutils literal"><span class="pre">int64</span></code>.  Whether
this is desirable or not is an open question; it is good for correctness,
but potentially bad for performance.</p>
</li>
<li><p class="first">In trying to follow the correctness over predictability rule, some values
can actually leave the integer realm.  For example, <code class="docutils literal"><span class="pre">int64</span> <span class="pre">+</span> <span class="pre">uint64</span></code>
is typed <code class="docutils literal"><span class="pre">float64</span></code> in order to avoid magnitude losses (but incidentally
will lose precision on large integer values...), again following Numpy&#8217;s
semantics for scalars.  This is usually not intended by the user.</p>
</li>
<li><p class="first">More complicated scenarios can produce unexpected errors at the type unification
stage.  An example is at <a class="reference external" href="https://github.com/numba/numba/issues/1299">Github issue 1299</a>,
the gist of which is reproduced here:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
</pre></div>
</div>
<p>At the time of this writing, this fails compiling, on a 64-bit system,
with the error:</p>
<div class="highlight-python"><div class="highlight"><pre>numba.errors.TypingError: Failed at nopython (nopython frontend)
Can&#39;t unify types of variable &#39;$48.4&#39;: $48.4 := {array(int32, 1d, C), array(int64, 1d, C)}
</pre></div>
</div>
<p>People expert with Numba&#8217;s type unification system can understand why.
But the user is caught in mystery.</p>
</li>
</ol>
</div>
<div class="section" id="proposal-predictable-width-conserving-typing">
<h2>7.1.1.2. Proposal: predictable width-conserving typing<a class="headerlink" href="#proposal-predictable-width-conserving-typing" title="Permalink to this headline">¶</a></h2>
<p>We propose to turn the current typing philosophy on its head.  Instead
of &#8220;<em>start small and grow as required</em>&#8221;, we propose &#8220;<em>start big and keep
the width unchanged</em>&#8221;.</p>
<p>Concretely:</p>
<ol class="arabic simple">
<li>The typing of Python <code class="docutils literal"><span class="pre">int</span></code> values used as function arguments doesn&#8217;t
change, as it works satisfyingly and doesn&#8217;t surprise the user.</li>
<li>The typing of integer <em>constants</em> (and pseudo-constants) changes to match
the typing of integer arguments.  That is, every non-explicitly typed
integer constant is typed <code class="docutils literal"><span class="pre">intp</span></code>, the pointer-sized integer; except for
the rare cases where <code class="docutils literal"><span class="pre">int64</span></code> (on 32-bit systems) or <code class="docutils literal"><span class="pre">uint64</span></code> is
required.</li>
<li>Operations on integers promote bitwidth to <code class="docutils literal"><span class="pre">intp</span></code>, if smaller, otherwise
they don&#8217;t promote.  For example, on a 32-bit machine, <code class="docutils literal"><span class="pre">int8</span> <span class="pre">+</span> <span class="pre">int8</span></code>
is typed <code class="docutils literal"><span class="pre">int32</span></code>, as is <code class="docutils literal"><span class="pre">int32</span> <span class="pre">+</span> <span class="pre">int32</span></code>.  However, <code class="docutils literal"><span class="pre">int64</span> <span class="pre">+</span> <span class="pre">int64</span></code>
is typed <code class="docutils literal"><span class="pre">int64</span></code>.</li>
<li>Furthermore, mixed operations between signed and unsigned fall back to
signed, while following the same bitwidth rule.  For example, on a
32-bit machine, <code class="docutils literal"><span class="pre">int8</span> <span class="pre">+</span> <span class="pre">uint16</span></code> is typed <code class="docutils literal"><span class="pre">int32</span></code>, as is
<code class="docutils literal"><span class="pre">uint32</span> <span class="pre">+</span> <span class="pre">int32</span></code>.</li>
</ol>
</div>
<div class="section" id="proposal-impact">
<h2>7.1.1.3. Proposal impact<a class="headerlink" href="#proposal-impact" title="Permalink to this headline">¶</a></h2>
<div class="section" id="semantics">
<h3>7.1.1.3.1. Semantics<a class="headerlink" href="#semantics" title="Permalink to this headline">¶</a></h3>
<p>With this proposal, the semantics become clearer.  Regardless of whether
the arguments and constants of a function were explicitly typed or not,
the results of various expressions at any point in the function have
easily predictable types.</p>
<p>When using built-in Python <code class="docutils literal"><span class="pre">int</span></code>, the user gets acceptable magnitude
(32 or 64 bits depending on the system&#8217;s bitness), and the type remains
the same accross all computations.</p>
<p>When explicitly using smaller bitwidths, intermediate results don&#8217;t
suffer from magnitude loss, since their bitwidth is promoted to <code class="docutils literal"><span class="pre">intp</span></code>.</p>
<p>There is also less potential for annoyances with the type unification
system as demonstrated above.  The user would have to force several
different types to be faced with such an error.</p>
<p>One potential cause for concern is the discrepancy with Numpy&#8217;s scalar
semantics; but at the same time this brings Numba scalar semantics closer
to array semantics (both Numba&#8217;s and Numpy&#8217;s), which seems a desirable
outcome as well.</p>
<p>It is worth pointing out that some sources of integer numbers, such
as the <code class="docutils literal"><span class="pre">range()</span></code> built-in, always yield 32-bit integers or larger.
This proposal could be an opportunity to standardize them on <code class="docutils literal"><span class="pre">intp</span></code>.</p>
</div>
<div class="section" id="performance">
<h3>7.1.1.3.2. Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h3>
<p>Except in trivial cases, it seems unlikely that the current &#8220;best fit&#8221;
behaviour for integer constants really brings a performance benefit.  After
all, most integers in Numba code would either be stored in arrays (with
well-known types, chosen by the user) or be used as indices, where a <code class="docutils literal"><span class="pre">int8</span></code>
is highly unlikely to fare better than a <code class="docutils literal"><span class="pre">intp</span></code> (actually, it may be worse,
if LLVM isn&#8217;t able to optimize away the required sign-extension).</p>
<p>As a side note, the default use of <code class="docutils literal"><span class="pre">intp</span></code> rather than <code class="docutils literal"><span class="pre">int64</span></code>
ensures that 32-bit systems won&#8217;t suffer from poor arithmetic performance.</p>
</div>
<div class="section" id="implementation">
<h3>7.1.1.3.3. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p>Optimistically, this proposal may simplify some Numba internals a bit.
Or, at least, it doesn&#8217;t threaten to make them significantly more complicated.</p>
</div>
<div class="section" id="limitations">
<h3>7.1.1.3.4. Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h3>
<p>This proposal doesn&#8217;t really solve the combination of signed and unsigned
integers.  It is geared mostly at solving the bitwidth issues, which are
a somewhat common cause of pain for users.  Unsigned integers are in
practice very uncommon in Numba-compiled code, except when explicitly
asked for, and therefore much less of a pain point.</p>
<p>On the bitwidth front, 32-bit systems could still show discrepancies based
on the values of constants: if a constant is too large to fit in 32 bits,
it is typed <code class="docutils literal"><span class="pre">int64</span></code>, which propagates through other computations.
This would be a reminiscence of the current behaviour, but rarer and much
more controlled still.</p>
</div>
<div class="section" id="long-term-horizon">
<h3>7.1.1.3.5. Long-term horizon<a class="headerlink" href="#long-term-horizon" title="Permalink to this headline">¶</a></h3>
<p>While we believe this proposal makes Numba&#8217;s behaviour more regular and more
predictable, it also pulls it further from general compatibility with pure
Python semantics, where users can assume arbitrary-precision integers without
any truncation issues.</p>
</div>
</div>
</div>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row-fluid">
<div class="related navbar ">
  <div class="navbar-inner">
    <ul class="nav pull-right">
      
        <li><a href="../genindex.html" title="General Index" >index</a></li>
        <li><a href="extension-points.html" title="7.2.1. NBEP 2: Extension points" >next</a></li>
        <li><a href="index.html" title="7. Numba Enhancement Proposals" >previous</a></li>
        <li><a href="../index.html">Numba 0.23.1+121.g4e7f360-py2.7-linux-x86_64.egg documentation</a></li>
        <li><a href="index.html" >7. Numba Enhancement Proposals</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer>
          &copy; Copyright 2012-2015, Continuum Analytics.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>