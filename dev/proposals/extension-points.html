<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>7.2.1. NBEP 2: Extension points &mdash; Numba 0.22.1+179.g196886c-py2.7-linux-x86_64.egg documentation</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
<link rel="stylesheet" href="../_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/font-awesome.min.css">
<!--[if IE 7]>
<link rel="stylesheet" href="../_static/css/font-awesome-ie7.min.css">
<![endif]-->
<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
}
</style>
<link rel="stylesheet" href="../_static/basicstrap.css" type="text/css" />
<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/bootstrap-responsive.min.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../',
            VERSION:     '0.22.1+179.g196886c-py2.7-linux-x86_64.egg',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="../_static/js/jquery.min.js"></script>
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    $('.show-sidebar').click(function(e) {
       e.preventDefault();
       if ($(".show-sidebar").html() == "Open Table Of Contents") {
          $('.for-mobile').removeClass('hidden-phone');
          $(".show-sidebar").html("Close Table Of Contents");
       } else {
          $(".show-sidebar").html("Open Table Of Contents");
       }
    });
  });
</script>
    <link rel="top" title="Numba 0.22.1+179.g196886c-py2.7-linux-x86_64.egg documentation" href="../index.html" />
    <link rel="up" title="7. Numba Enhancement Proposals" href="index.html" />
    <link rel="next" title="8. Glossary" href="../glossary.html" />
    <link rel="prev" title="7.1.1. NBEP 1: Changes in integer typing" href="integer-typing.html" /> 
  </head>
  <body>
    <div class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../index.html">Numba 0.22.1+179.g196886c-py2.7-linux-x86_64.egg documentation</a>
          <div class="nav-collapse collapse">
            <ul class="nav pull-right">
              
                <li>
                <a href="../genindex.html" title="General Index" accesskey="I">index</a>
                </li>
                <li>
                <a href="../glossary.html" title="8. Glossary" accesskey="N">next</a>
                </li>
                <li>
                <a href="integer-typing.html" title="7.1.1. NBEP 1: Changes in integer typing" accesskey="P">previous</a>
                </li>
                <li>
                <a href="index.html" accesskey="U">7. Numba Enhancement Proposals</a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">


      
      <div class="row-fluid hidden-desktop hidden-tablet">
      
<div class="span3 ">
  <a class="visible-phone btn btn-small show-sidebar" data-toggle="collapse" data-target=".for-mobile">Open Table Of Contents</a>
  <div class="for-mobile sidebar hidden-phone">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.2.1. NBEP 2: Extension points</a><ul>
<li><a class="reference internal" href="#high-level-api">7.2.1.1. High-level API</a><ul>
<li><a class="reference internal" href="#proposed-changes">7.2.1.1.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#typing">7.2.1.2. Typing</a><ul>
<li><a class="reference internal" href="#numba-types">7.2.1.2.1. Numba types</a><ul>
<li><a class="reference internal" href="#id1">7.2.1.2.1.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#type-inference-on-values">7.2.1.2.2. Type inference on values</a><ul>
<li><a class="reference internal" href="#id2">7.2.1.2.2.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fast-path-for-type-inference-on-function-arguments">7.2.1.2.3. Fast path for type inference on function arguments</a><ul>
<li><a class="reference internal" href="#id3">7.2.1.2.3.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#type-inference-on-operations">7.2.1.2.4. Type inference on operations</a><ul>
<li><a class="reference internal" href="#id4">7.2.1.2.4.1. Proposed changes</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#code-generation">7.2.1.3. Code generation</a><ul>
<li><a class="reference internal" href="#concrete-representation-of-values-of-a-numba-type">7.2.1.3.1. Concrete representation of values of a Numba type</a><ul>
<li><a class="reference internal" href="#id5">7.2.1.3.1.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conversion-between-types">7.2.1.3.2. Conversion between types</a><ul>
<li><a class="reference internal" href="#id6">7.2.1.3.2.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-an-operation">7.2.1.3.3. Implementation of an operation</a><ul>
<li><a class="reference internal" href="#id7">7.2.1.3.3.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conversion-from-to-python-objects">7.2.1.3.4. Conversion from / to Python objects</a><ul>
<li><a class="reference internal" href="#id8">7.2.1.3.4.1. Proposed changes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="integer-typing.html"
                        title="previous chapter">7.1.1. NBEP 1: Changes in integer typing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../glossary.html"
                        title="next chapter">8. Glossary</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/proposals/extension-points.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox">
  <h3>Quick search</h3>
  <form class="search form-search" action="../search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="Go" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div>
      </div>
      

      <!-- row -->
      <div class="row-fluid">
         
<div class="span3 visible-desktop visible-tablet">
  <div class=" sidebar hidden-phone">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7.2.1. NBEP 2: Extension points</a><ul>
<li><a class="reference internal" href="#high-level-api">7.2.1.1. High-level API</a><ul>
<li><a class="reference internal" href="#proposed-changes">7.2.1.1.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#typing">7.2.1.2. Typing</a><ul>
<li><a class="reference internal" href="#numba-types">7.2.1.2.1. Numba types</a><ul>
<li><a class="reference internal" href="#id1">7.2.1.2.1.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#type-inference-on-values">7.2.1.2.2. Type inference on values</a><ul>
<li><a class="reference internal" href="#id2">7.2.1.2.2.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fast-path-for-type-inference-on-function-arguments">7.2.1.2.3. Fast path for type inference on function arguments</a><ul>
<li><a class="reference internal" href="#id3">7.2.1.2.3.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#type-inference-on-operations">7.2.1.2.4. Type inference on operations</a><ul>
<li><a class="reference internal" href="#id4">7.2.1.2.4.1. Proposed changes</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#code-generation">7.2.1.3. Code generation</a><ul>
<li><a class="reference internal" href="#concrete-representation-of-values-of-a-numba-type">7.2.1.3.1. Concrete representation of values of a Numba type</a><ul>
<li><a class="reference internal" href="#id5">7.2.1.3.1.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conversion-between-types">7.2.1.3.2. Conversion between types</a><ul>
<li><a class="reference internal" href="#id6">7.2.1.3.2.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-of-an-operation">7.2.1.3.3. Implementation of an operation</a><ul>
<li><a class="reference internal" href="#id7">7.2.1.3.3.1. Proposed changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conversion-from-to-python-objects">7.2.1.3.4. Conversion from / to Python objects</a><ul>
<li><a class="reference internal" href="#id8">7.2.1.3.4.1. Proposed changes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="integer-typing.html"
                        title="previous chapter">7.1.1. NBEP 1: Changes in integer typing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../glossary.html"
                        title="next chapter">8. Glossary</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/proposals/extension-points.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox">
  <h3>Quick search</h3>
  <form class="search form-search" action="../search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="Go" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div> 
        

        <div class="span9">
          <div class="document">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <div class="section" id="nbep-2-extension-points">
<h1>7.2.1. NBEP 2: Extension points<a class="headerlink" href="#nbep-2-extension-points" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Antoine Pitrou</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">July 2015</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
</tbody>
</table>
<p>Implementing new types or functions in Numba requires hooking into
various mechanisms along the compilation chain (and potentially
outside of it).  This document aims, first, at examining the
current ways of doing so and, second, at making proposals to make
extending easier.</p>
<p>If some of the proposals are implemented, we should first strive
to use and exercise them internally, before exposing the APIs to the
public.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This document doesn&#8217;t cover CUDA or any other non-CPU backend.</p>
</div>
<div class="section" id="high-level-api">
<h2>7.2.1.1. High-level API<a class="headerlink" href="#high-level-api" title="Permalink to this headline">¶</a></h2>
<p>There is currently no high-level API for quick implementation of
an existing function or type.</p>
<div class="section" id="proposed-changes">
<h3>7.2.1.1.1. Proposed changes<a class="headerlink" href="#proposed-changes" title="Permalink to this headline">¶</a></h3>
<p>It would be nice for people to be able to implement a function
in a single go, as if they were writing a <code class="docutils literal"><span class="pre">&#64;jit</span></code> function.
As an example, let&#8217;s assume we want to make <a class="reference external" href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.where.html#numpy.where" title="(in NumPy v1.10)"><code class="xref py py-func docutils literal"><span class="pre">numpy.where()</span></code></a>
usable from <a class="reference internal" href="../glossary.html#term-nopython-mode"><span class="xref std std-term">nopython mode</span></a>.  We would like to be able
to define several implementations and select between them at
compile-time depending on the input types.</p>
<p>The following example showcases a hypothetical API where we can
register a function taking the argument types and returning a
callable implementing the actual function for those types.
The API should also be able to handle optional arguments, and
the resulting implementation should support calling with named
parameters.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">numba.extending</span> <span class="kn">import</span> <span class="n">overlay</span>

<span class="nd">@overlay</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement np.where().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Choose implementation based on argument types.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
        <span class="c"># Array where() =&gt; return an array of the same shape</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ty</span><span class="o">.</span><span class="n">layout</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="k">for</span> <span class="n">ty</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
            <span class="k">def</span> <span class="nf">where_impl</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Fast implementation for C-contiguous arrays</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape</span> <span class="ow">or</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;all inputs should have the same shape&quot;</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">cf</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">flat</span>
                <span class="n">xf</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flat</span>
                <span class="n">yf</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">flat</span>
                <span class="n">rf</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">flat</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                    <span class="n">rf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">cf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">yf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">where_impl</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Generic implementation for other arrays</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape</span> <span class="ow">or</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;all inputs should have the same shape&quot;</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">cond</span><span class="p">):</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="k">else</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">res</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">where_impl</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Scalar where() =&gt; return a 0-dim array</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">scal</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">y</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">scal</span><span class="p">,</span> <span class="n">scal</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">where_impl</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="typing">
<h2>7.2.1.2. Typing<a class="headerlink" href="#typing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="numba-types">
<h3>7.2.1.2.1. Numba types<a class="headerlink" href="#numba-types" title="Permalink to this headline">¶</a></h3>
<p>Numba&#8217;s standard types are declared in <code class="xref py py-mod docutils literal"><span class="pre">numba.types</span></code>.  To declare
a new type, one subclasses the base <code class="xref py py-class docutils literal"><span class="pre">Type</span></code> class or one of its
existing abstract subclasses, and implements the required functionality.</p>
<div class="section" id="id1">
<h4>7.2.1.2.1.1. Proposed changes<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>No change required.</p>
</div>
</div>
<div class="section" id="type-inference-on-values">
<h3>7.2.1.2.2. Type inference on values<a class="headerlink" href="#type-inference-on-values" title="Permalink to this headline">¶</a></h3>
<p>Values of a new type need to be type-inferred if they can appear as
function arguments or constants.  The core machinery is in
<code class="xref py py-mod docutils literal"><span class="pre">numba.typing.typeof</span></code>.</p>
<p>In the common case where some Python class or classes map exclusively
to the new type, one can extend a generic function to dispatch on said
classes, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numba.typing.typeof</span> <span class="kn">import</span> <span class="n">typeof_impl</span>

<span class="nd">@typeof_impl</span><span class="p">(</span><span class="n">MyClass</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_typeof_myclass</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
   <span class="k">if</span> <span class="s">&quot;some condition&quot;</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">MyType</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">typeof_impl</span></code> specialization must return a Numba type instance,
or None if the value failed typing.</p>
<p>In the rarer case where the new type can denote various Python classes
that are impossible to enumerate, one must insert a manual check in the
fallback implementation of the <code class="docutils literal"><span class="pre">typeof_impl</span></code> generic function.</p>
<div class="section" id="id2">
<h4>7.2.1.2.2.1. Proposed changes<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Allow people to define a generic hook without monkeypatching the
fallback implementation.</p>
</div>
</div>
<div class="section" id="fast-path-for-type-inference-on-function-arguments">
<h3>7.2.1.2.3. Fast path for type inference on function arguments<a class="headerlink" href="#fast-path-for-type-inference-on-function-arguments" title="Permalink to this headline">¶</a></h3>
<p>Optionally, one may want to allow a new type to participate in the
fast type resolution (written in C code) to minimize function call
overhead when a JIT-compiled function is called with the new type.
One must then insert the required checks and implementation in
the <code class="docutils literal"><span class="pre">_typeof.c</span></code> file, presumably inside the <code class="docutils literal"><span class="pre">compute_fingerprint()</span></code>
function.</p>
<div class="section" id="id3">
<h4>7.2.1.2.3.1. Proposed changes<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>None.  Adding generic hooks to C code embedded in a C Python extension
is too delicate a change.</p>
</div>
</div>
<div class="section" id="type-inference-on-operations">
<h3>7.2.1.2.4. Type inference on operations<a class="headerlink" href="#type-inference-on-operations" title="Permalink to this headline">¶</a></h3>
<p>Values resulting from various operations (function calls, operators, etc.)
are typed using a set of helpers called &#8220;templates&#8221;.  One can define a
new template by subclass one of the existing base classes and implement
the desired inference mechanism.  The template is explicitly registered
with the type inference machinery using a decorator.</p>
<p>The <code class="xref py py-class docutils literal"><span class="pre">ConcreteTemplate</span></code> base class allows one to define inference as
a set of supported signatures for a given operation.  The following example
types the modulo operator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@builtin</span>
<span class="k">class</span> <span class="nc">BinOpMod</span><span class="p">(</span><span class="n">ConcreteTemplate</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;%&quot;</span>
    <span class="n">cases</span> <span class="o">=</span> <span class="p">[</span><span class="n">signature</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">signed_domain</span><span class="p">)]</span>
    <span class="n">cases</span> <span class="o">+=</span> <span class="p">[</span><span class="n">signature</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">unsigned_domain</span><span class="p">)]</span>
    <span class="n">cases</span> <span class="o">+=</span> <span class="p">[</span><span class="n">signature</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">real_domain</span><span class="p">)]</span>
</pre></div>
</div>
<p>(note that type <em>instances</em> are used in the signatures, severely
limiting the amount of genericity that can be expressed)</p>
<p>The <code class="xref py py-class docutils literal"><span class="pre">AbstractTemplate</span></code> base class allows to define inference
programmatically, giving it full flexibility.  Here is a simplistic
example of how tuple indexing (i.e. the <code class="docutils literal"><span class="pre">__getitem__</span></code> operator) can
be expressed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@builtin</span>
<span class="k">class</span> <span class="nc">GetItemUniTuple</span><span class="p">(</span><span class="n">AbstractTemplate</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;getitem&quot;</span>

    <span class="k">def</span> <span class="nf">generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">):</span>
        <span class="n">tup</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">UniTuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">signature</span><span class="p">(</span><span class="n">tup</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">tup</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-class docutils literal"><span class="pre">AttributeTemplate</span></code> base class allows to type the attributes
and methods of a given type.  Here is an example, typing the <code class="docutils literal"><span class="pre">.real</span></code>
and <code class="docutils literal"><span class="pre">.imag</span></code> attributes of complex numbers:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@builtin_attr</span>
<span class="k">class</span> <span class="nc">ComplexAttribute</span><span class="p">(</span><span class="n">AttributeTemplate</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Complex</span>

    <span class="k">def</span> <span class="nf">resolve_real</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ty</span><span class="o">.</span><span class="n">underlying_float</span>

    <span class="k">def</span> <span class="nf">resolve_imag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ty</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ty</span><span class="o">.</span><span class="n">underlying_float</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="xref py py-class docutils literal"><span class="pre">AttributeTemplate</span></code> only works for getting attributes.  Setting
an attribute&#8217;s value is hardcoded in <code class="xref py py-mod docutils literal"><span class="pre">numba.typeinfer</span></code>.</p>
</div>
<p>The <code class="xref py py-class docutils literal"><span class="pre">CallableTemplate</span></code> base class offers an easier way to parse
flexible function signatures, by letting one define a callable that has
the same definition as the function being typed.  For example, here is how
one could hypothetically type Python&#8217;s <code class="docutils literal"><span class="pre">sorted</span></code> function if Numba supported
lists:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@builtin</span>
<span class="k">class</span> <span class="nc">Sorted</span><span class="p">(</span><span class="n">CallableTemplate</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">sorted</span>

    <span class="k">def</span> <span class="nf">generic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">typer</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Boolean</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Callable</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">iterable</span><span class="o">.</span><span class="n">iterator_type</span><span class="o">.</span><span class="n">yield_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">typer</span>
</pre></div>
</div>
<p>(note you can return just the function&#8217;s return type instead of the
full signature)</p>
<div class="section" id="id4">
<h4>7.2.1.2.4.1. Proposed changes<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>If we expose some of this, should we streamline the API first?
The class-based API can feel clumsy, one could instead imagine
a functional API for some of the template kinds:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@type_callable</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">type_sorted</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">typer</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># [same function as above]</span>

    <span class="k">return</span> <span class="n">typer</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-generation">
<h2>7.2.1.3. Code generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="concrete-representation-of-values-of-a-numba-type">
<h3>7.2.1.3.1. Concrete representation of values of a Numba type<a class="headerlink" href="#concrete-representation-of-values-of-a-numba-type" title="Permalink to this headline">¶</a></h3>
<p>Any concrete Numba type must be able to be represented in LLVM form
(for variable storage, argument passing, etc.).  One defines that
representation by implementing a datamodel class and registering it
with a decorator.  Datamodel classes for standard types are defined
in <code class="xref py py-mod docutils literal"><span class="pre">numba.datamodel.models</span></code>.</p>
<div class="section" id="id5">
<h4>7.2.1.3.1.1. Proposed changes<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>No change required.</p>
</div>
</div>
<div class="section" id="conversion-between-types">
<h3>7.2.1.3.2. Conversion between types<a class="headerlink" href="#conversion-between-types" title="Permalink to this headline">¶</a></h3>
<p>Implicit conversion between Numba types is currently implemented as a
monolithic sequence of choices and type checks in the
<code class="xref py py-meth docutils literal"><span class="pre">BaseContext.cast()</span></code> method.  To add a new implicit conversion, one
appends a type-specific check in that method.</p>
<p>Boolean evaluation is a special case of implicit conversion (the
destination type being <code class="xref py py-class docutils literal"><span class="pre">types.Boolean</span></code>).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Explicit conversion is seen as a regular operation, e.g. a constructor
call.</p>
</div>
<div class="section" id="id6">
<h4>7.2.1.3.2.1. Proposed changes<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>Implicit conversion could use some kind of generic function, with multiple
dispatch based on the source and destination types.</p>
</div>
</div>
<div class="section" id="implementation-of-an-operation">
<h3>7.2.1.3.3. Implementation of an operation<a class="headerlink" href="#implementation-of-an-operation" title="Permalink to this headline">¶</a></h3>
<p>Other operations are implemented and registered using a set of generic
functions and decorators.  For example, here is how lookup for a the <code class="docutils literal"><span class="pre">.ndim</span></code>
attribute on Numpy arrays is implemented:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@builtin_attr</span>
<span class="nd">@impl_attribute</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Kind</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Array</span><span class="p">),</span> <span class="s">&quot;ndim&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">intp</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">array_ndim</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">get_constant</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">intp</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
</pre></div>
</div>
<p>And here is how calling <code class="docutils literal"><span class="pre">len()</span></code> on a tuple value is implemented:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@builtin</span>
<span class="nd">@implement</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">len_type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Kind</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">BaseTuple</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">tuple_len</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">tupty</span><span class="p">,</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">args</span>
    <span class="n">retty</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_type</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">get_constant</span><span class="p">(</span><span class="n">retty</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tupty</span><span class="o">.</span><span class="n">types</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="id7">
<h4>7.2.1.3.3.1. Proposed changes<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>No changes required.  Perhaps review and streamine the API (drop the
requirement to write <code class="docutils literal"><span class="pre">types.Kind(...)</span></code> explicitly?).</p>
</div>
</div>
<div class="section" id="conversion-from-to-python-objects">
<h3>7.2.1.3.4. Conversion from / to Python objects<a class="headerlink" href="#conversion-from-to-python-objects" title="Permalink to this headline">¶</a></h3>
<p>Some types need to be converted from or to Python objects, if they can
be passed as function arguments or returned from a function.  The
corresponding boxing and unboxing operations are implemented using
a generic function.  The implementations for standard Numba types
are in <code class="xref py py-mod docutils literal"><span class="pre">numba.targets.boxing</span></code>.  For example, here is the boxing
implementation for a boolean value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@box</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">box_bool</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="n">longval</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">zext</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">pyapi</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">pyapi</span><span class="o">.</span><span class="n">bool_from_long</span><span class="p">(</span><span class="n">longval</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="id8">
<h4>7.2.1.3.4.1. Proposed changes<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>Perhaps change the implementation signature slightly, from <code class="docutils literal"><span class="pre">(c,</span> <span class="pre">typ,</span> <span class="pre">val)</span></code>
to <code class="docutils literal"><span class="pre">(typ,</span> <span class="pre">val,</span> <span class="pre">c)</span></code>, to match the one chosen for the <code class="docutils literal"><span class="pre">typeof_impl</span></code>
generic function.</p>
</div>
</div>
</div>
</div>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row-fluid">
<div class="related navbar ">
  <div class="navbar-inner">
    <ul class="nav pull-right">
      
        <li><a href="../genindex.html" title="General Index" >index</a></li>
        <li><a href="../glossary.html" title="8. Glossary" >next</a></li>
        <li><a href="integer-typing.html" title="7.1.1. NBEP 1: Changes in integer typing" >previous</a></li>
        <li><a href="../index.html">Numba 0.22.1+179.g196886c-py2.7-linux-x86_64.egg documentation</a></li>
        <li><a href="index.html" >7. Numba Enhancement Proposals</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer>
          &copy; Copyright 2012-2015, Continuum Analytics.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>