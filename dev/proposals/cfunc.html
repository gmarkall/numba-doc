<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8.2.3. NBEP 4: Defining C callbacks &mdash; Numba 0.39.0.dev0+134.g07993db-py2.7-linux-x86_64.egg documentation</title>
    
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.39.0.dev0+134.g07993db-py2.7-linux-x86_64.egg',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="Numba 0.39.0.dev0+134.g07993db-py2.7-linux-x86_64.egg documentation" href="../index.html" />
    <link rel="up" title="8. Numba Enhancement Proposals" href="index.html" />
    <link rel="next" title="8.2.4. NBEP 5: Type Inference" href="type-inference.html" />
    <link rel="prev" title="8.2.2. NBEP 3: JIT Classes" href="jit-classes.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/numba_blue_icon_rgb.png"></span>
          Numba</a>
        <span class="navbar-text navbar-version pull-left"><b>0.39</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hsa/index.html">5. Numba for HSA APUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">7. Developer Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">8.2.3. NBEP 4: Defining C callbacks</a><ul>
<li><a class="reference internal" href="#basic-usage">8.2.3.1. Basic usage</a><ul>
<li><a class="reference internal" href="#calling-from-numba-compiled-functions">8.2.3.1.1. Calling from Numba-compiled functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#passing-array-data">8.2.3.2. Passing array data</a></li>
<li><a class="reference internal" href="#error-handling">8.2.3.3. Error handling</a></li>
<li><a class="reference internal" href="#deferred-topics">8.2.3.4. Deferred topics</a><ul>
<li><a class="reference internal" href="#ahead-of-time-compilation">8.2.3.4.1. Ahead-of-Time compilation</a></li>
<li><a class="reference internal" href="#opaque-data-pointers">8.2.3.4.2. Opaque data pointers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="jit-classes.html" title="Previous Chapter: 8.2.2. NBEP 3: JIT Classes"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 8.2.2. NBEP 3: J...</span>
    </a>
  </li>
  <li>
    <a href="type-inference.html" title="Next Chapter: 8.2.4. NBEP 5: Type Inference"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">8.2.4. NBEP 5: T... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/proposals/cfunc.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="nbep-4-defining-c-callbacks">
<h1>8.2.3. NBEP 4: Defining C callbacks<a class="headerlink" href="#nbep-4-defining-c-callbacks" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Antoine Pitrou</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">April 2016</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
</tbody>
</table>
<p>Interfacing with some native libraries (for example written in C
or C++) can necessitate writing native callbacks to provide business logic
to the library.  Some Python-facing libraries may also provide the
alternative of passing a ctypes-wrapped native callback instead of a
Python callback for better performance.  A simple example is the
<code class="docutils literal"><span class="pre">scipy.integrate</span></code> package where the user passes the function to be
integrated as a callback.</p>
<p>Users of those libraries may want to benefit from the performance advantage
of running purely native code, while writing their code in Python.
This proposal outlines a scheme to provide such a functionality in
Numba.</p>
<div class="section" id="basic-usage">
<h2>8.2.3.1. Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h2>
<p>We propose adding a new decorator, <code class="docutils literal"><span class="pre">&#64;cfunc</span></code>, importable from the main
package.  This decorator allows defining a callback as in the following
example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cfunc</span>
<span class="kn">from</span> <span class="nn">numba.types</span> <span class="kn">import</span> <span class="n">float64</span>

<span class="c"># A callback with the C signature `double(double)`</span>

<span class="nd">@cfunc</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">float64</span><span class="p">),</span> <span class="n">nopython</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">&#64;cfunc</span></code> decorator returns a &#8220;C function&#8221; object holding the
resources necessary to run the given compiled function (for example its
LLVM module).  This object has several attributes and methods:</p>
<ul class="simple">
<li>the <code class="docutils literal"><span class="pre">ctypes</span></code> attribute is a ctypes function object representing
the native function.</li>
<li>the <code class="docutils literal"><span class="pre">address</span></code> attribute is the address of the native function code, as
an integer (note this can also be computed from the <code class="docutils literal"><span class="pre">ctypes</span></code> attribute).</li>
<li>the <code class="docutils literal"><span class="pre">native_name</span></code> attribute is the symbol under which the function
can be looked up inside the current process.</li>
<li>the <code class="docutils literal"><span class="pre">inspect_llvm()</span></code> method returns the IR for the LLVM module
in which the function is compiled.  It is expected that the <code class="docutils literal"><span class="pre">native_name</span></code>
attribute corresponds to the function&#8217;s name in the LLVM IR.</li>
</ul>
<p>The general signature of the decorator is <code class="docutils literal"><span class="pre">cfunc(signature,</span> <span class="pre">**options)</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">signature</span></code> must specify the argument types and return type of the
function using Numba types.  In contrary to <code class="docutils literal"><span class="pre">&#64;jit</span></code>, the return type cannot
be omitted.</p>
<p>The <code class="docutils literal"><span class="pre">options</span></code> are keyword-only parameters specifying compilation options.
We are expecting that the standard <code class="docutils literal"><span class="pre">&#64;jit</span></code> options (<code class="docutils literal"><span class="pre">nopython</span></code>,
<code class="docutils literal"><span class="pre">forceobj</span></code>, <code class="docutils literal"><span class="pre">cache</span></code>) can be made to work with <code class="docutils literal"><span class="pre">&#64;cfunc</span></code>.</p>
<div class="section" id="calling-from-numba-compiled-functions">
<h3>8.2.3.1.1. Calling from Numba-compiled functions<a class="headerlink" href="#calling-from-numba-compiled-functions" title="Permalink to this headline">¶</a></h3>
<p>While the intended use is to pass a callback&#8217;s address to foreign C
code expecting a function pointer, it should be made possible to call
the C callback from a Numba-compiled function.</p>
</div>
</div>
<div class="section" id="passing-array-data">
<h2>8.2.3.2. Passing array data<a class="headerlink" href="#passing-array-data" title="Permalink to this headline">¶</a></h2>
<p>Native platform ABIs as used by C or C++ don&#8217;t have the notion of a shaped
array as in Numpy.  One common solution is to pass a raw data pointer and
one or several size arguments (depending on dimensionality).  Numba must
provide a way to rebuild an array view of this data inside the callback.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cfunc</span><span class="p">,</span> <span class="n">carray</span>
<span class="kn">from</span> <span class="nn">numba.types</span> <span class="kn">import</span> <span class="n">float64</span><span class="p">,</span> <span class="n">CPointer</span><span class="p">,</span> <span class="n">void</span><span class="p">,</span> <span class="n">intp</span>

<span class="c"># A callback with the C signature `void(double *, double *, size_t)`</span>

<span class="nd">@cfunc</span><span class="p">(</span><span class="n">void</span><span class="p">(</span><span class="n">CPointer</span><span class="p">(</span><span class="n">float64</span><span class="p">),</span> <span class="n">CPointer</span><span class="p">(</span><span class="n">float64</span><span class="p">),</span> <span class="n">intp</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">,</span> <span class="n">out_ptr</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">in_</span> <span class="o">=</span> <span class="n">carray</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">carray</span><span class="p">(</span><span class="n">out_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">in_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">carray</span></code> function takes <code class="docutils literal"><span class="pre">(pointer,</span> <span class="pre">shape,</span> <span class="pre">dtype)</span></code> arguments
(<code class="docutils literal"><span class="pre">dtype</span></code> being optional) and returns a C-layout array view over the
data <em>pointer</em>, with the given <em>shape</em> and <em>dtype</em>.  <em>pointer</em> must
be a ctypes pointer object (not a Python integer).  The array&#8217;s
dimensionality corresponds to the <em>shape</em> tuple&#8217;s length.  If <em>dtype</em>
is not given, the array&#8217;s dtype corresponds to the <em>pointer</em>&#8216;s pointee
type.</p>
<p>The <code class="docutils literal"><span class="pre">farray</span></code> function is similar except that it returns a F-layout
array view.</p>
</div>
<div class="section" id="error-handling">
<h2>8.2.3.3. Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>There is no standard mechanism in C for error reporting.  Unfortunately,
Numba currently doesn&#8217;t handle <code class="docutils literal"><span class="pre">try..except</span></code> blocks, which makes it more
difficult for the user to implement the required error reporting scheme.
The current stance of this proposal is to let users guard against invalid
arguments where necessary, and do whatever is required to inform the caller
of the error.</p>
<p>Based on user feedback, we can later add support for some error reporting
schemes, such as returning an integer error code depending on whether an
exception was raised, or setting <code class="docutils literal"><span class="pre">errno</span></code>.</p>
</div>
<div class="section" id="deferred-topics">
<h2>8.2.3.4. Deferred topics<a class="headerlink" href="#deferred-topics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ahead-of-time-compilation">
<h3>8.2.3.4.1. Ahead-of-Time compilation<a class="headerlink" href="#ahead-of-time-compilation" title="Permalink to this headline">¶</a></h3>
<p>This proposal doesn&#8217;t make any provision for AOT compilation of C callbacks.
It would probably necessitate a separate API (a new method on the
<code class="docutils literal"><span class="pre">numba.pycc.CC</span></code> object), and the implementation would require exposing
a subset of the C function object&#8217;s functionality from the compiled C
extension module.</p>
</div>
<div class="section" id="opaque-data-pointers">
<h3>8.2.3.4.2. Opaque data pointers<a class="headerlink" href="#opaque-data-pointers" title="Permalink to this headline">¶</a></h3>
<p>Some libraries allow passing an opaque data pointer (<code class="docutils literal"><span class="pre">void</span> <span class="pre">*</span></code>) to a
user-provided callback, to provide any required context for execution
of the callback.  Taking advantage of this functionality would require
adding specific support in Numba, for example the ability to do generic
conversion from <code class="docutils literal"><span class="pre">types.voidptr</span></code> and to take the address of a
Python-facing <code class="docutils literal"><span class="pre">jitclass</span></code> instance.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012, Anaconda, Inc..<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>