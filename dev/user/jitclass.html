<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>1.7. Compiling Python classes with @jitclass &#8212; Numba 0.47.0.dev0+539.g71ebcc9-py3.7-linux-x86_64.egg documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/numba-docs.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1.8. Creating C callbacks with @cfunc" href="cfunc.html" />
    <link rel="prev" title="1.6. Creating Numpy universal functions" href="vectorize.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/numba_blue_icon_rgb.png"></span>
          Numba</a>
        <span class="navbar-text navbar-version pull-left"><b>0.47</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">7. Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">1.7. Compiling Python classes with <code class="docutils literal notranslate"><span class="pre">&#64;jitclass</span></code></a><ul>
<li><a class="reference internal" href="#basic-usage">1.7.1. Basic usage</a></li>
<li><a class="reference internal" href="#specifying-numba-typed-containers-as-class-members">1.7.2. Specifying <code class="docutils literal notranslate"><span class="pre">numba.typed</span></code> containers as class members</a></li>
<li><a class="reference internal" href="#support-operations">1.7.3. Support operations</a></li>
<li><a class="reference internal" href="#limitations">1.7.4. Limitations</a></li>
<li><a class="reference internal" href="#the-decorator-jitclass">1.7.5. The decorator: <code class="docutils literal notranslate"><span class="pre">&#64;jitclass</span></code></a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="vectorize.html" title="Previous Chapter: 1.6. Creating Numpy universal functions"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 1.6. Creating...</span>
    </a>
  </li>
  <li>
    <a href="cfunc.html" title="Next Chapter: 1.8. Creating C callbacks with @cfunc"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">1.8. Creating... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/user/jitclass.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="compiling-python-classes-with-jitclass">
<span id="jitclass"></span><h1>1.7. Compiling Python classes with <code class="docutils literal notranslate"><span class="pre">&#64;jitclass</span></code><a class="headerlink" href="#compiling-python-classes-with-jitclass" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is a early version of jitclass support. Not all compiling features are
exposed or implemented, yet.</p>
</div>
<p>Numba supports code generation for classes via the <a class="reference internal" href="#numba.jitclass" title="numba.jitclass"><code class="xref py py-func docutils literal notranslate"><span class="pre">numba.jitclass()</span></code></a>
decorator.  A class can be marked for optimization using this decorator along
with a specification of the types of each field.  We call the resulting class
object a <em>jitclass</em>.  All methods of a jitclass are compiled into nopython
functions.  The data of a jitclass instance is allocated on the heap as a
C-compatible structure so that any compiled functions can have direct access
to the underlying data, bypassing the interpreter.</p>
<div class="section" id="basic-usage">
<h2>1.7.1. Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h2>
<p>Here’s an example of a jitclass:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="k">import</span> <span class="n">jitclass</span>          <span class="c1"># import the decorator</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="k">import</span> <span class="n">int32</span><span class="p">,</span> <span class="n">float32</span>    <span class="c1"># import the types</span>

<span class="n">spec</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">int32</span><span class="p">),</span>               <span class="c1"># a simple scalar field</span>
    <span class="p">(</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">float32</span><span class="p">[:]),</span>          <span class="c1"># an array field</span>
<span class="p">]</span>

<span class="nd">@jitclass</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Bag</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span>
</pre></div>
</div>
<p>(see full example at <cite>examples/jitclass.py</cite> from the source tree)</p>
<p>In the above example, a <code class="docutils literal notranslate"><span class="pre">spec</span></code> is provided as a list of 2-tuples.  The tuples
contain the name of the field and the Numba type of the field.  Alternatively,
user can use a dictionary (an <code class="docutils literal notranslate"><span class="pre">OrderedDict</span></code> preferably for stable field
ordering), which maps field names to types.</p>
<p>The definition of the class requires at least a <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method for
initializing each defined fields.  Uninitialized fields contains garbage data.
Methods and properties (getters and setters only) can be defined.  They will be
automatically compiled.</p>
</div>
<div class="section" id="specifying-numba-typed-containers-as-class-members">
<h2>1.7.2. Specifying <code class="docutils literal notranslate"><span class="pre">numba.typed</span></code> containers as class members<a class="headerlink" href="#specifying-numba-typed-containers-as-class-members" title="Permalink to this headline">¶</a></h2>
<p>It is often desirable to use a <code class="docutils literal notranslate"><span class="pre">numba.typed.Dict</span></code> or a <code class="docutils literal notranslate"><span class="pre">numba.typed.List</span></code> as
a class member in a <code class="docutils literal notranslate"><span class="pre">jitclass</span></code>. Methods for using these types and various
common patterns are presented in the following:</p>
<p>First, using explicit Numba types and explicit construction.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jitclass</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">typed</span>

<span class="c1"># key and value types</span>
<span class="n">kv_ty</span> <span class="o">=</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">unicode_type</span><span class="p">)</span>

<span class="c1"># A container class with:</span>
<span class="c1"># * member &#39;d&#39; holding a typed dictionary of int64 -&gt; unicode string (kv_ty)</span>
<span class="c1"># * member &#39;l&#39; holding a typed list of float64</span>
<span class="nd">@jitclass</span><span class="p">([(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="o">*</span><span class="n">kv_ty</span><span class="p">)),</span>
           <span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">))])</span>
<span class="k">class</span> <span class="nc">ContainerHolder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># initialize the containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="o">*</span><span class="n">kv_ty</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">container</span> <span class="o">=</span> <span class="n">ContainerHolder</span><span class="p">()</span>
<span class="n">container</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;apple&quot;</span>
<span class="n">container</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
<span class="n">container</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">123.</span><span class="p">)</span>
<span class="n">container</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">456.</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="c1"># {1: apple, 2: orange}</span>
<span class="k">print</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="c1"># [123.0, 456.0]</span>
</pre></div>
</div>
<p>Another useful pattern is to use the <code class="docutils literal notranslate"><span class="pre">numba.typed</span></code> container attribute
<code class="docutils literal notranslate"><span class="pre">_numba_type_</span></code> to find the type of a container, this can be accessed directly
from an instance of the container in the Python interpreter. The same
information can be obtained by calling <a class="reference internal" href="../reference/types.html#numba.typeof" title="numba.typeof"><code class="xref py py-func docutils literal notranslate"><span class="pre">numba.typeof()</span></code></a> on the instance. For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jitclass</span><span class="p">,</span> <span class="n">typed</span><span class="p">,</span> <span class="n">typeof</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;apple&quot;</span>
<span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
<span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">123.</span><span class="p">)</span>
<span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">456.</span><span class="p">)</span>


<span class="nd">@jitclass</span><span class="p">([(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="n">d</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="n">l</span><span class="p">))])</span>
<span class="k">class</span> <span class="nc">ContainerInstHolder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_inst</span><span class="p">,</span> <span class="n">list_inst</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">dict_inst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">list_inst</span>

<span class="n">container</span> <span class="o">=</span> <span class="n">ContainerInstHolder</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">d</span><span class="p">)</span> <span class="c1"># {1: apple, 2: orange}</span>
<span class="k">print</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">l</span><span class="p">)</span> <span class="c1"># [123.0, 456.0]</span>
</pre></div>
</div>
<p>It is worth noting that the instance of the container in a <code class="docutils literal notranslate"><span class="pre">jitclass</span></code> must be
initialized before use, for example, this will cause an invalid memory access
as <code class="docutils literal notranslate"><span class="pre">self.d</span></code> is written to without <code class="docutils literal notranslate"><span class="pre">d</span></code> being initialized as a <code class="docutils literal notranslate"><span class="pre">type.Dict</span></code>
instance of the type specified.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jitclass</span><span class="p">,</span> <span class="n">types</span>

<span class="n">dict_ty</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">unicode_type</span><span class="p">)</span>

<span class="nd">@jitclass</span><span class="p">([(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">dict_ty</span><span class="p">)])</span>
<span class="k">class</span> <span class="nc">NotInitilisingContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;apple&quot;</span> <span class="c1"># this is invalid, `d` is not initialized</span>

<span class="n">NotInitilisingContainer</span><span class="p">()</span> <span class="c1"># segmentation fault/memory access violation</span>
</pre></div>
</div>
</div>
<div class="section" id="support-operations">
<h2>1.7.3. Support operations<a class="headerlink" href="#support-operations" title="Permalink to this headline">¶</a></h2>
<p>The following operations of jitclasses work in both the interpreter and Numba
compiled functions:</p>
<ul class="simple">
<li>calling the jitclass class object to construct a new instance
(e.g. <code class="docutils literal notranslate"><span class="pre">mybag</span> <span class="pre">=</span> <span class="pre">Bag(123)</span></code>);</li>
<li>read/write access to attributes and properties (e.g. <code class="docutils literal notranslate"><span class="pre">mybag.value</span></code>);</li>
<li>calling methods (e.g. <code class="docutils literal notranslate"><span class="pre">mybag.increment(3)</span></code>);</li>
</ul>
<p>Using jitclasses in Numba compiled function is more efficient.
Short methods can be inlined (at the discretion of LLVM inliner).
Attributes access are simply reading from a C structure.
Using jitclasses from the interpreter has the same overhead of calling any
Numba compiled function from the interpreter.  Arguments and return values
must be unboxed or boxed between Python objects and native representation.
Values encapsulated by a jitclass does not get boxed into Python object when
the jitclass instance is handed to the interpreter.  It is during attribute
access to the field values that they are boxed.</p>
</div>
<div class="section" id="limitations">
<h2>1.7.4. Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A jitclass class object is treated as a function (the constructor) inside
a Numba compiled function.</li>
<li><code class="docutils literal notranslate"><span class="pre">isinstance()</span></code> only works in the interpreter.</li>
<li>Manipulating jitclass instances in the interpreter is not optimized, yet.</li>
<li>Support for jitclasses are available on CPU only.
(Note: Support for GPU devices is planned for a future release.)</li>
</ul>
</div>
<div class="section" id="the-decorator-jitclass">
<h2>1.7.5. The decorator: <code class="docutils literal notranslate"><span class="pre">&#64;jitclass</span></code><a class="headerlink" href="#the-decorator-jitclass" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="numba.jitclass">
<code class="descclassname">numba.</code><code class="descname">jitclass</code><span class="sig-paren">(</span><em>spec</em><span class="sig-paren">)</span><a class="headerlink" href="#numba.jitclass" title="Permalink to this definition">¶</a></dt>
<dd><p>A decorator for creating a jitclass.</p>
<p><strong>arguments</strong>:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>spec:</dt>
<dd>Specifies the types of each field on this class.
Must be a dictionary or a sequence.
With a dictionary, use collections.OrderedDict for stable ordering.
With a sequence, it must contain 2-tuples of (fieldname, fieldtype).</dd>
</dl>
</li>
</ul>
<p><strong>returns</strong>:</p>
<p>A callable that takes a class object, which will be compiled.</p>
</dd></dl>

</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012, Anaconda, Inc..<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>