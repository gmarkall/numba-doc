<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>7.5. Notes on generators &#8212; Numba 0.46.0.dev0+363.g2da803c-py2.7-linux-x86_64.egg documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/numba-docs.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7.6. Notes on Numba Runtime" href="numba-runtime.html" />
    <link rel="prev" title="7.4. Polymorphic dispatching" href="dispatching.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/numba_blue_icon_rgb.png"></span>
          Numba</a>
        <span class="navbar-text navbar-version pull-left"><b>0.46</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">7.5. Notes on generators</a><ul>
<li><a class="reference internal" href="#terminology">7.5.1. Terminology</a></li>
<li><a class="reference internal" href="#function-analysis">7.5.2. Function analysis</a></li>
<li><a class="reference internal" href="#the-generator-structure">7.5.3. The generator structure</a><ul>
<li><a class="reference internal" href="#layout">7.5.3.1. Layout</a></li>
<li><a class="reference internal" href="#allocation">7.5.3.2. Allocation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#compiling-to-native-code">7.5.4. Compiling to native code</a><ul>
<li><a class="reference internal" href="#the-next-function">7.5.4.1. The next() function</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="dispatching.html" title="Previous Chapter: 7.4. Polymorphic dispatching"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 7.4. Polymorp...</span>
    </a>
  </li>
  <li>
    <a href="numba-runtime.html" title="Next Chapter: 7.6. Notes on Numba Runtime"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">7.6. Notes on... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/developer/generators.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="notes-on-generators">
<span id="arch-generators"></span><h1>7.5. Notes on generators<a class="headerlink" href="#notes-on-generators" title="Permalink to this headline">¶</a></h1>
<p>Numba recently gained support for compiling generator functions.  This
document explains some of the implementation choices.</p>
<div class="section" id="terminology">
<h2>7.5.1. Terminology<a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h2>
<p>For clarity, we distinguish between <em>generator functions</em> and
<em>generators</em>.  A generator function is a function containing one or
several <code class="docutils literal notranslate"><span class="pre">yield</span></code> statements.  A generator (sometimes also called “generator
iterator”) is the return value of a generator function; it resumes
execution inside its frame each time <a class="reference external" href="https://docs.python.org/3/library/functions.html#next" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">next()</span></code></a> is called.</p>
<p>A <em>yield point</em> is the place where a <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement is called.
A <em>resumption point</em> is the place just after a <em>yield point</em> where execution
is resumed when <a class="reference external" href="https://docs.python.org/3/library/functions.html#next" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">next()</span></code></a> is called again.</p>
</div>
<div class="section" id="function-analysis">
<h2>7.5.2. Function analysis<a class="headerlink" href="#function-analysis" title="Permalink to this headline">¶</a></h2>
<p>Suppose we have the following simple generator function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">yield</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
</pre></div>
</div>
<p>Here is its CPython bytecode, as printed out using <a class="reference external" href="https://docs.python.org/3/library/dis.html#dis.dis" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">dis.dis()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="mi">7</span>           <span class="mi">0</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="mi">3</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="mi">6</span> <span class="n">BINARY_ADD</span>
            <span class="mi">7</span> <span class="n">YIELD_VALUE</span>
            <span class="mi">8</span> <span class="n">POP_TOP</span>

<span class="mi">8</span>           <span class="mi">9</span> <span class="n">LOAD_FAST</span>                <span class="mi">0</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
           <span class="mi">12</span> <span class="n">LOAD_FAST</span>                <span class="mi">1</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>
           <span class="mi">15</span> <span class="n">BINARY_SUBTRACT</span>
           <span class="mi">16</span> <span class="n">YIELD_VALUE</span>
           <span class="mi">17</span> <span class="n">POP_TOP</span>
           <span class="mi">18</span> <span class="n">LOAD_CONST</span>               <span class="mi">0</span> <span class="p">(</span><span class="k">None</span><span class="p">)</span>
           <span class="mi">21</span> <span class="n">RETURN_VALUE</span>
</pre></div>
</div>
<p>When compiling this function with <span class="target" id="index-0"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_DUMP_IR"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_DUMP_IR</span></code></a> set to 1, the
following information is printed out:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>----------------------------------IR DUMP: gen----------------------------------
label 0:
    x = arg(0, name=x)                       [&#39;x&#39;]
    y = arg(1, name=y)                       [&#39;y&#39;]
    $0.3 = x + y                             [&#39;$0.3&#39;, &#39;x&#39;, &#39;y&#39;]
    $0.4 = yield $0.3                        [&#39;$0.3&#39;, &#39;$0.4&#39;]
    del $0.4                                 []
    del $0.3                                 []
    $0.7 = x - y                             [&#39;$0.7&#39;, &#39;x&#39;, &#39;y&#39;]
    del y                                    []
    del x                                    []
    $0.8 = yield $0.7                        [&#39;$0.7&#39;, &#39;$0.8&#39;]
    del $0.8                                 []
    del $0.7                                 []
    $const0.9 = const(NoneType, None)        [&#39;$const0.9&#39;]
    $0.10 = cast(value=$const0.9)            [&#39;$0.10&#39;, &#39;$const0.9&#39;]
    del $const0.9                            []
    return $0.10                             [&#39;$0.10&#39;]
------------------------------GENERATOR INFO: gen-------------------------------
generator state variables: [&#39;$0.3&#39;, &#39;$0.7&#39;, &#39;x&#39;, &#39;y&#39;]
yield point #1: live variables = [&#39;x&#39;, &#39;y&#39;], weak live variables = [&#39;$0.3&#39;]
yield point #2: live variables = [], weak live variables = [&#39;$0.7&#39;]
</pre></div>
</div>
<p>What does it mean? The first part is the Numba IR, as already seen in
<a class="reference internal" href="architecture.html#arch-generate-numba-ir"><span class="std std-ref">Stage 2: Generate the Numba IR</span></a>.  We can see the two yield points (<code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">$0.3</span></code>
and <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">$0.7</span></code>).</p>
<p>The second part shows generator-specific information.  To understand it
we have to understand what suspending and resuming a generator means.</p>
<p>When suspending a generator, we are not merely returning a value to the
caller (the operand of the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement).  We also have to save the
generator’s <em>current state</em> in order to resume execution.  In trivial use
cases, perhaps the CPU’s register values or stack slots would be preserved
until the next call to next().  However, any non-trivial case will hopelessly
clobber those values, so we have to save them in a well-defined place.</p>
<p>What are the values we need to save?  Well, in the context of the Numba
Intermediate Representation, we must save all <em>live variables</em> at each
yield point.  These live variables are computed thanks to the control
flow graph.</p>
<p>Once live variables are saved and the generator is suspended, resuming
the generator simply involves the inverse operation: the live variables
are restored from the saved generator state.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is the same analysis which helps insert Numba <code class="docutils literal notranslate"><span class="pre">del</span></code> instructions
where appropriate.</p>
</div>
<p>Let’s go over the generator info again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">generator</span> <span class="n">state</span> <span class="n">variables</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;$0.3&#39;</span><span class="p">,</span> <span class="s">&#39;$0.7&#39;</span><span class="p">,</span> <span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;y&#39;</span><span class="p">]</span>
<span class="k">yield</span> <span class="n">point</span> <span class="c">#1: live variables = [&#39;x&#39;, &#39;y&#39;], weak live variables = [&#39;$0.3&#39;]</span>
<span class="k">yield</span> <span class="n">point</span> <span class="c">#2: live variables = [], weak live variables = [&#39;$0.7&#39;]</span>
</pre></div>
</div>
<p>Numba has computed the union of all live variables (denoted as “state
variables”).  This will help define the layout of the <a class="reference internal" href="#generator-structure"><span class="std std-ref">generator
structure</span></a>.  Also, for each yield point, we have
computed two sets of variables:</p>
<ul class="simple">
<li>the <em>live variables</em> are the variables which are used by code following
the resumption point (i.e. after the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement)</li>
<li>the <em>weak live variables</em> are variables which are del’ed immediately
after the resumption point; they have to be saved in <a class="reference internal" href="../glossary.html#term-object-mode"><span class="xref std std-term">object mode</span></a>,
to ensure proper reference cleanup</li>
</ul>
</div>
<div class="section" id="the-generator-structure">
<span id="generator-structure"></span><h2>7.5.3. The generator structure<a class="headerlink" href="#the-generator-structure" title="Permalink to this headline">¶</a></h2>
<div class="section" id="layout">
<h3>7.5.3.1. Layout<a class="headerlink" href="#layout" title="Permalink to this headline">¶</a></h3>
<p>Function analysis helps us gather enough information to define the
layout of the generator structure, which will store the entire execution
state of a generator.  Here is a sketch of the generator structure’s layout,
in pseudo-code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="n">struct</span> <span class="n">gen_struct_t</span> <span class="p">{</span>
   <span class="n">int32_t</span> <span class="n">resume_index</span><span class="p">;</span>
   <span class="n">struct</span> <span class="n">gen_args_t</span> <span class="p">{</span>
      <span class="n">arg_0_t</span> <span class="n">arg0</span><span class="p">;</span>
      <span class="n">arg_1_t</span> <span class="n">arg1</span><span class="p">;</span>
      <span class="o">...</span>
      <span class="n">arg_N_t</span> <span class="n">argN</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">struct</span> <span class="n">gen_state_t</span> <span class="p">{</span>
      <span class="n">state_0_t</span> <span class="n">state_var0</span><span class="p">;</span>
      <span class="n">state_1_t</span> <span class="n">state_var1</span><span class="p">;</span>
      <span class="o">...</span>
      <span class="n">state_N_t</span> <span class="n">state_varN</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let’s describe those fields in order.</p>
<ul class="simple">
<li>The first member, the <em>resume index</em>, is an integer telling the generator
at which resumption point execution must resume.  By convention, it can
have two special values: 0 means execution must start at the beginning of
the generator (i.e. the first time <a class="reference external" href="https://docs.python.org/3/library/functions.html#next" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">next()</span></code></a> is called); -1 means
the generator is exhausted and resumption must immediately raise
StopIteration.  Other values indicate the yield point’s index starting from 1
(corresponding to the indices shown in the generator info above).</li>
<li>The second member, the <em>arguments structure</em> is read-only after it is first
initialized.  It stores the values of the arguments the generator function
was called with.  In our example, these are the values of <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>.</li>
<li>The third member, the <em>state structure</em>, stores the live variables as
computed above.</li>
</ul>
<p>Concretely, our example’s generator structure (assuming the generator
function is called with floating-point numbers) is then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre>struct gen_struct_t {
   int32_t resume_index;
   struct gen_args_t {
      double arg0;
      double arg1;
   }
   struct gen_state_t {
      double $0.3;
      double $0.7;
      double x;
      double y;
   }
}
</pre></div>
</div>
<p>Note that here, saving <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> is redundant: Numba isn’t able to
recognize that the state variables <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> have the same value
as <code class="docutils literal notranslate"><span class="pre">arg0</span></code> and <code class="docutils literal notranslate"><span class="pre">arg1</span></code>.</p>
</div>
<div class="section" id="allocation">
<h3>7.5.3.2. Allocation<a class="headerlink" href="#allocation" title="Permalink to this headline">¶</a></h3>
<p>How does Numba ensure the generator structure is preserved long enough?
There are two cases:</p>
<ul class="simple">
<li>When a Numba-compiled generator function is called from a Numba-compiled
function, the structure is allocated on the stack by the callee.  In this
case, generator instantiation is practically costless.</li>
<li>When a Numba-compiled generator function is called from regular Python
code, a CPython-compatible wrapper is instantiated that has the right
amount of allocated space to store the structure, and whose
<a class="reference external" href="https://docs.python.org/3/c-api/typeobj.html#c.PyTypeObject.tp_iternext" title="(in Python v3.7)"><code class="xref c c-member docutils literal notranslate"><span class="pre">tp_iternext</span></code></a> slot is a wrapper around the
generator’s native code.</li>
</ul>
</div>
</div>
<div class="section" id="compiling-to-native-code">
<h2>7.5.4. Compiling to native code<a class="headerlink" href="#compiling-to-native-code" title="Permalink to this headline">¶</a></h2>
<p>When compiling a generator function, three native functions are actually
generated by Numba:</p>
<ul class="simple">
<li>An initialization function.  This is the function corresponding
to the generator function itself: it receives the function arguments and
stores them inside the generator structure (which is passed by pointer).
It also initialized the <em>resume index</em> to 0, indicating that the generator
hasn’t started yet.</li>
<li>A next() function.  This is the function called to resume execution
inside the generator.  Its single argument is a pointer to the generator
structure and it returns the next yielded value (or a special exit code
is used if the generator is exhausted, for quick checking when called
from Numba-compiled functions).</li>
<li>An optional finalizer.  In object mode, this function ensures that all
live variables stored in the generator state are decref’ed, even if the
generator is destroyed without having been exhausted.</li>
</ul>
<div class="section" id="the-next-function">
<h3>7.5.4.1. The next() function<a class="headerlink" href="#the-next-function" title="Permalink to this headline">¶</a></h3>
<p>The next() function is the least straight-forward of the three native
functions.  It starts with a trampoline which dispatches execution to the
right resume point depending on the <em>resume index</em> stored in the generator
structure.  Here is how the function start may look like in our example:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span class="k">define</span> <span class="k">i32</span> <span class="vg">@&quot;__main__.gen.next&quot;</span><span class="p">(</span>
   <span class="kt">double</span><span class="p">*</span> <span class="k">nocapture</span> <span class="nv">%retptr</span><span class="p">,</span>
   <span class="p">{</span> <span class="k">i8</span><span class="p">*,</span> <span class="k">i32</span> <span class="p">}**</span> <span class="k">nocapture</span> <span class="k">readnone</span> <span class="nv">%excinfo</span><span class="p">,</span>
   <span class="k">i8</span><span class="p">*</span> <span class="k">nocapture</span> <span class="k">readnone</span> <span class="nv">%env</span><span class="p">,</span>
   <span class="p">{</span> <span class="k">i32</span><span class="p">,</span> <span class="p">{</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span> <span class="p">},</span> <span class="p">{</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span> <span class="p">}</span> <span class="p">}*</span> <span class="k">nocapture</span> <span class="nv">%arg.gen</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nl">entry:</span>
     <span class="nv">%gen.resume_index</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="p">{</span> <span class="k">i32</span><span class="p">,</span> <span class="p">{</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span> <span class="p">},</span> <span class="p">{</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="kt">double</span> <span class="p">}</span> <span class="p">}*</span> <span class="nv">%arg.gen</span><span class="p">,</span> <span class="k">i64</span> <span class="m">0</span><span class="p">,</span> <span class="k">i32</span> <span class="m">0</span>
     <span class="nv">%.47</span> <span class="p">=</span> <span class="k">load</span> <span class="k">i32</span><span class="p">*</span> <span class="nv">%gen.resume_index</span><span class="p">,</span> <span class="k">align</span> <span class="m">4</span>
     <span class="k">switch</span> <span class="k">i32</span> <span class="nv">%.47</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%stop_iteration</span> <span class="p">[</span>
       <span class="k">i32</span> <span class="m">0</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%B0</span>
       <span class="k">i32</span> <span class="m">1</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%generator_resume1</span>
       <span class="k">i32</span> <span class="m">2</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%generator_resume2</span>
     <span class="p">]</span>

  <span class="c">; rest of the function snipped</span>
</pre></div>
</div>
<p>(uninteresting stuff trimmed from the LLVM IR to make it more readable)</p>
<p>We recognize the pointer to the generator structure in <code class="docutils literal notranslate"><span class="pre">%arg.gen</span></code>.
The trampoline switch has three targets (one for each <em>resume index</em> 0, 1
and 2), and a fallback target label named <code class="docutils literal notranslate"><span class="pre">stop_iteration</span></code>.  Label <code class="docutils literal notranslate"><span class="pre">B0</span></code>
represents the function’s start, <code class="docutils literal notranslate"><span class="pre">generator_resume1</span></code> (resp.
<code class="docutils literal notranslate"><span class="pre">generator_resume2</span></code>) is the resumption point after the first
(resp. second) yield point.</p>
<p>After generation by LLVM, the whole native assembly code for this function
may look like this (on x86-64):</p>
<div class="highlight-asm notranslate"><div class="highlight"><pre>        <span class="na">.globl</span>  <span class="no">__main__.gen.next</span>
        <span class="na">.align</span>  <span class="mi">16</span><span class="p">,</span> <span class="mi">0x90</span>
<span class="nl">__main__.gen.next:</span>
        <span class="nf">movl</span>    <span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span> <span class="nv">%eax</span>
        <span class="nf">cmpl</span>    <span class="no">$2</span><span class="p">,</span> <span class="nv">%eax</span>
        <span class="nf">je</span>      <span class="no">.LBB1_5</span>
        <span class="nf">cmpl</span>    <span class="no">$1</span><span class="p">,</span> <span class="nv">%eax</span>
        <span class="nf">jne</span>     <span class="no">.LBB1_2</span>
        <span class="nf">movsd</span>   <span class="mi">40</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span> <span class="nv">%xmm0</span>
        <span class="nf">subsd</span>   <span class="mi">48</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span> <span class="nv">%xmm0</span>
        <span class="nf">movl</span>    <span class="no">$2</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rcx</span><span class="p">)</span>
        <span class="nf">movsd</span>   <span class="nv">%xmm0</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rdi</span><span class="p">)</span>
        <span class="nf">xorl</span>    <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%eax</span>
        <span class="nf">retq</span>
<span class="nl">.LBB1_5:</span>
        <span class="nf">movl</span>    <span class="no">$-1</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rcx</span><span class="p">)</span>
        <span class="nf">jmp</span>     <span class="no">.LBB1_6</span>
<span class="nl">.LBB1_2:</span>
        <span class="nf">testl</span>   <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%eax</span>
        <span class="nf">jne</span>     <span class="no">.LBB1_6</span>
        <span class="nf">movsd</span>   <span class="mi">8</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span> <span class="nv">%xmm0</span>
        <span class="nf">movsd</span>   <span class="mi">16</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span> <span class="nv">%xmm1</span>
        <span class="nf">movaps</span>  <span class="nv">%xmm0</span><span class="p">,</span> <span class="nv">%xmm2</span>
        <span class="nf">addsd</span>   <span class="nv">%xmm1</span><span class="p">,</span> <span class="nv">%xmm2</span>
        <span class="nf">movsd</span>   <span class="nv">%xmm1</span><span class="p">,</span> <span class="mi">48</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">)</span>
        <span class="nf">movsd</span>   <span class="nv">%xmm0</span><span class="p">,</span> <span class="mi">40</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">)</span>
        <span class="nf">movl</span>    <span class="no">$1</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rcx</span><span class="p">)</span>
        <span class="nf">movsd</span>   <span class="nv">%xmm2</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rdi</span><span class="p">)</span>
        <span class="nf">xorl</span>    <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%eax</span>
        <span class="nf">retq</span>
<span class="nl">.LBB1_6:</span>
        <span class="nf">movl</span>    <span class="no">$-3</span><span class="p">,</span> <span class="nv">%eax</span>
        <span class="nf">retq</span>
</pre></div>
</div>
<p>Note the function returns 0 to indicate a value is yielded, -3 to indicate
StopIteration. <code class="docutils literal notranslate"><span class="pre">%rcx</span></code> points to the start of the generator structure,
where the resume index is stored.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012, Anaconda, Inc..<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>