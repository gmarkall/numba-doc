<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>7.7. Live Variable Analysis &mdash; Numba 0.40.0.dev0+316.ge5364a3-py2.7-linux-x86_64.egg documentation</title>
    
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.40.0.dev0+316.ge5364a3-py2.7-linux-x86_64.egg',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="Numba 0.40.0.dev0+316.ge5364a3-py2.7-linux-x86_64.egg documentation" href="../index.html" />
    <link rel="up" title="7. Developer Manual" href="index.html" />
    <link rel="next" title="7.8. Listings" href="listings.html" />
    <link rel="prev" title="7.6. Using the Numba Rewrite Pass for Fun and Optimization" href="rewrites.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/numba_blue_icon_rgb.png"></span>
          Numba</a>
        <span class="navbar-text navbar-version pull-left"><b>0.40</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">7.7. Live Variable Analysis</a><ul>
<li><a class="reference internal" href="#notes-on-behavior-of-the-live-variable-analysis">7.7.1. Notes on behavior of the live variable analysis</a><ul>
<li><a class="reference internal" href="#variable-deleted-before-definition">7.7.1.1. Variable deleted before definition</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="rewrites.html" title="Previous Chapter: 7.6. Using the Numba Rewrite Pass for Fun and Optimization"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 7.6. Using the N...</span>
    </a>
  </li>
  <li>
    <a href="listings.html" title="Next Chapter: 7.8. Listings"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">7.8. Listings &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/developer/live_variable_analysis.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="live-variable-analysis">
<span id="id1"></span><h1>7.7. Live Variable Analysis<a class="headerlink" href="#live-variable-analysis" title="Permalink to this headline">¶</a></h1>
<p>(Releated issue <a class="reference external" href="https://github.com/numba/numba/pull/1611">https://github.com/numba/numba/pull/1611</a>)</p>
<p>Numba uses reference-counting for garbage collection, a technique that
requires cooperation by the compiler.  The Numba IR encodes the location
where a decref must be inserted.  These locations are determined by live
variable analysis.  The corresponding source code is the <code class="docutils literal"><span class="pre">_insert_var_dels()</span></code>
method in <a class="reference external" href="https://github.com/numba/numba/blob/master/numba/interpreter.py">https://github.com/numba/numba/blob/master/numba/interpreter.py</a>.</p>
<p>In Python semantic, once a variable is defined inside a function, it is alive
until the variable is explicitly deleted or the function scope is ended.
However, Numba analyzes the code to determine the minimum bound of the lifetime
of each variable by its definition and usages during compilation.
As soon as a variable is unreachable, a <code class="docutils literal"><span class="pre">del</span></code> instruction is inserted at the
closest basic-block (either at the start of the next block(s) or at the
end of the current block).  This means variables can be released earlier than in
regular Python code.</p>
<p>The behavior of the live variable analysis affects memory usage of the compiled
code.  Internally, Numba does not differentiate temporary variables and user
variables.  Since each operation generates at least one temporary variable,
a function can accumulate a high number of temporary variables if they are not
released as soon as possible.
Our generator implementation can benefit from early releasing of variables,
which reduces the size of the state to suspend at each yield point.</p>
<div class="section" id="notes-on-behavior-of-the-live-variable-analysis">
<h2>7.7.1. Notes on behavior of the live variable analysis<a class="headerlink" href="#notes-on-behavior-of-the-live-variable-analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="variable-deleted-before-definition">
<h3>7.7.1.1. Variable deleted before definition<a class="headerlink" href="#variable-deleted-before-definition" title="Permalink to this headline">¶</a></h3>
<p>(Related issue: <a class="reference external" href="https://github.com/numba/numba/pull/1738">https://github.com/numba/numba/pull/1738</a>)</p>
<p>When a variable lifetime is confined within the loop body (its definition and
usage does not escape the loop body), like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
  <span class="c"># BB 0</span>
  <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="c"># BB 1</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
      <span class="c"># BB 2</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="c"># BB 3</span>
          <span class="n">res</span> <span class="o">+=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="c"># BB 4</span>
  <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>Variable <code class="docutils literal"><span class="pre">t</span></code> is never referenced outside of the loop.
A <code class="docutils literal"><span class="pre">del</span></code> instruction is emitted for <code class="docutils literal"><span class="pre">t</span></code> at the head of the loop (BB 1)
before a variable is defined.  The reason is obvious once we know the control
flow graph:</p>
<div class="highlight-python"><div class="highlight"><pre>         +------------------------------&gt; BB4
         |
         |
BB 0 --&gt; BB 1  --&gt;  BB 2 ---&gt; BB 3
         ^          |          |
         |          V          V
         +---------------------+
</pre></div>
</div>
<p>Variable <code class="docutils literal"><span class="pre">t</span></code> is defined in BB 1.  In BB 2, the evaluation of
<code class="docutils literal"><span class="pre">t[i]</span> <span class="pre">&gt;</span> <span class="pre">1</span></code> uses <code class="docutils literal"><span class="pre">t</span></code>, which is the last use if execution takes the false
branch and goto BB 1.  In BB 3, <code class="docutils literal"><span class="pre">t</span></code> is only used in <code class="docutils literal"><span class="pre">res</span> <span class="pre">+=</span> <span class="pre">t[i]</span></code>, which is
the last use if execution takes the true branch.  Because BB 3, an outgoing
branch of BB 2 uses <code class="docutils literal"><span class="pre">t</span></code>, <code class="docutils literal"><span class="pre">t</span></code> must be deleted at the common predecessor.
The closest point is BB 1, which does not have <code class="docutils literal"><span class="pre">t</span></code> defined from the incoming
edge of BB 0.</p>
<p>Alternatively, if <code class="docutils literal"><span class="pre">t</span></code> is deleted at BB 4, we will still have to delete the
variable before its definition because BB4 can be executed without executing
the loop body (BB 2 and BB 3), where the variable is defined.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012, Anaconda, Inc..<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>