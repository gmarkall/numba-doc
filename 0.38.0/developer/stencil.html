<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>7.9. Notes on stencils &#8212; Numba 0.38.0rc1+0.ga0390f6.dirty documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.38.0rc1+0.ga0390f6.dirty',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7.10. Notes on Custom Pipelines" href="custom_pipeline.html" />
    <link rel="prev" title="7.8.1. Lowering Listing" href="autogen_lower_listing.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/numba_blue_icon_rgb.png"></span>
          Numba</a>
        <span class="navbar-text navbar-version pull-left"><b>0.38</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hsa/index.html">5. Numba for HSA APUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">7.9. Notes on stencils</a><ul>
<li><a class="reference internal" href="#the-stencil-decorator">7.9.1. The stencil decorator</a></li>
<li><a class="reference internal" href="#handling-the-three-modes">7.9.2. Handling the three modes</a><ul>
<li><a class="reference internal" href="#outside-jit-context">7.9.2.1. Outside jit context</a></li>
<li><a class="reference internal" href="#jit-without-parallel-true">7.9.2.2. Jit without <code class="docutils literal"><span class="pre">parallel=True</span></code></a></li>
<li><a class="reference internal" href="#jit-with-parallel-true">7.9.2.3. Jit with <code class="docutils literal"><span class="pre">parallel=True</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-the-stencil-function">7.9.3. Creating the stencil function</a></li>
<li><a class="reference internal" href="#exceptions-raised">7.9.4. Exceptions raised</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="autogen_lower_listing.html" title="Previous Chapter: 7.8.1. Lowering Listing"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 7.8.1. Loweri...</span>
    </a>
  </li>
  <li>
    <a href="custom_pipeline.html" title="Next Chapter: 7.10. Notes on Custom Pipelines"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">7.10. Notes o... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/developer/stencil.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="notes-on-stencils">
<span id="arch-stencil"></span><h1>7.9. Notes on stencils<a class="headerlink" href="#notes-on-stencils" title="Permalink to this headline">¶</a></h1>
<p>Numba provides the <a class="reference internal" href="../user/stencil.html#numba-stencil"><span class="std std-ref">&#64;stencil decorator</span></a> to
represent stencil computations.  This document explains how this
feature is implemented in the several different modes available in
Numba.  Currently, calls to the stencil from non-jitted code is
supported as well as calls from jitted code, either with or without
the <a class="reference internal" href="../user/jit.html#parallel-jit-option"><span class="std std-ref">parallel=True</span></a> option.</p>
<div class="section" id="the-stencil-decorator">
<h2>7.9.1. The stencil decorator<a class="headerlink" href="#the-stencil-decorator" title="Permalink to this headline">¶</a></h2>
<p>The stencil decorator itself just returns a <code class="docutils literal"><span class="pre">StencilFunc</span></code> object.
This object encapsulates the original stencil kernel function
as specified in the program and the options passed to the
stencil decorator.  Also of note is that after the first compilation
of the stencil, the computed neighborhood of the stencil is
stored in the <code class="docutils literal"><span class="pre">StencilFunc</span></code> object in the <code class="docutils literal"><span class="pre">neighborhood</span></code> attribute.</p>
</div>
<div class="section" id="handling-the-three-modes">
<h2>7.9.2. Handling the three modes<a class="headerlink" href="#handling-the-three-modes" title="Permalink to this headline">¶</a></h2>
<p>As mentioned above, Numba supports the calling of stencils
from inside or outside a <code class="docutils literal"><span class="pre">&#64;jit</span></code> compiled function, with or
without the <a class="reference internal" href="../user/jit.html#parallel-jit-option"><span class="std std-ref">parallel=True</span></a> option.</p>
<div class="section" id="outside-jit-context">
<h3>7.9.2.1. Outside jit context<a class="headerlink" href="#outside-jit-context" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">StencilFunc</span></code> overrides the <code class="docutils literal"><span class="pre">__call__</span></code> method so that calls
to <code class="docutils literal"><span class="pre">StencilFunc</span></code> objects execute the stencil:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>

    <span class="n">new_stencil_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stencil_wrapper</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_stencil_func</span><span class="o">.</span><span class="n">entry_point</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_stencil_func</span><span class="o">.</span><span class="n">entry_point</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>First, the presence of the optional <a class="reference internal" href="../user/stencil.html#stencil-function-out"><span class="std std-ref">out</span></a>
parameter is checked.  If it is present then the output array is
stored in <code class="docutils literal"><span class="pre">result</span></code>.  Then, the call to <code class="docutils literal"><span class="pre">_stencil_wrapper</span></code>
generates the stencil function given the result and argument types
and finally the generated stencil function is executed and its result
returned.</p>
</div>
<div class="section" id="jit-without-parallel-true">
<h3>7.9.2.2. Jit without <code class="docutils literal"><span class="pre">parallel=True</span></code><a class="headerlink" href="#jit-without-parallel-true" title="Permalink to this headline">¶</a></h3>
<p>When constructed, a <code class="docutils literal"><span class="pre">StencilFunc</span></code> inserts itself into the typing
context’s set of user functions and provides the <code class="docutils literal"><span class="pre">_type_me</span></code>
callback.  In this way, the standard Numba compiler is able to
determine the output type and signature of a <code class="docutils literal"><span class="pre">StencilFunc</span></code>.
Each <code class="docutils literal"><span class="pre">StencilFunc</span></code> maintains a cache of previously seen combinations
of input argument types and keyword types.  If previously seen,
the <code class="docutils literal"><span class="pre">StencilFunc</span></code> returns the computed signature.  If not previously
computed, the <code class="docutils literal"><span class="pre">StencilFunc</span></code> computes the return type of the stencil
by running the Numba compiler frontend on the stencil kernel and
then performing type inference on the <a class="reference internal" href="../glossary.html#term-numba-ir"><span class="xref std std-term">Numba IR</span></a> (IR) to get the scalar
return type of the kernel.  From that, a Numpy array type is constructed
whose element type matches that scalar return type.</p>
<p>After computing the signature of the stencil for a previously
unseen combination of input and keyword types, the <code class="docutils literal"><span class="pre">StencilFunc</span></code>
then <a class="reference internal" href="#arch-stencil-create-function"><span class="std std-ref">creates the stencil function</span></a> itself.
<code class="docutils literal"><span class="pre">StencilFunc</span></code> then installs the new stencil function’s definition
in the target context so that jitted code is able to call it.</p>
<p>Thus, in this mode, the generated stencil function is a stand-alone
function called like a normal function from within jitted code.</p>
</div>
<div class="section" id="jit-with-parallel-true">
<h3>7.9.2.3. Jit with <code class="docutils literal"><span class="pre">parallel=True</span></code><a class="headerlink" href="#jit-with-parallel-true" title="Permalink to this headline">¶</a></h3>
<p>When calling a <code class="docutils literal"><span class="pre">StencilFunc</span></code> from a jitted context with <code class="docutils literal"><span class="pre">parallel=True</span></code>,
a separate stencil function as generated by <a class="reference internal" href="#arch-stencil-create-function"><span class="std std-ref">Creating the stencil function</span></a>
is not used.  Instead, <cite>parfors</cite> (<a class="reference internal" href="architecture.html#parallel-accelerator"><span class="std std-ref">Stage 6b: Perform Automatic Parallelization</span></a>) are
created within the current function that implements the stencil.
This code again starts with the stencil kernel and does a similar kernel
size computation but then rather than standard Python looping syntax,
corresponding <cite>parfors</cite> are created so that the execution of the stencil
will take place in parallel.</p>
<p>The stencil to <cite>parfor</cite> translations can also be selectively disabled
by setting <code class="docutils literal"><span class="pre">parallel={'stencil':</span> <span class="pre">False}</span></code>, among other sub-options
described in <a class="reference internal" href="architecture.html#parallel-accelerator"><span class="std std-ref">Stage 6b: Perform Automatic Parallelization</span></a>.</p>
</div>
</div>
<div class="section" id="creating-the-stencil-function">
<span id="arch-stencil-create-function"></span><h2>7.9.3. Creating the stencil function<a class="headerlink" href="#creating-the-stencil-function" title="Permalink to this headline">¶</a></h2>
<p>Conceptually, a stencil function is created from the user-specified
stencil kernel by adding looping code around the kernel, transforming
the relative kernel indices into absolute array indices based on the
loop indices, and replacing the kernel’s <code class="docutils literal"><span class="pre">return</span></code> statement with
a statement to assign the computed value into the output array.</p>
<p>To accomplish this transformation, first, a copy of the stencil
kernel IR is created so that subsequent modifications of the IR
for different stencil signatures will not effect each other.</p>
<p>Then, an approach similar to how GUFunc’s are created for <cite>parfors</cite>
is employed.  In a text buffer, a Python function is created with
a unique name.  The input array parameter is added to the function
definition and if the <code class="docutils literal"><span class="pre">out</span></code> argument type is present then an
<code class="docutils literal"><span class="pre">out</span></code> parameter is added to the stencil function definition.
If the <code class="docutils literal"><span class="pre">out</span></code> argument is not present then first an output array
is created with <code class="docutils literal"><span class="pre">numpy.zeros</span></code> having the same shape as the
input array.</p>
<p>The kernel is then analyzed to compute the stencil size and the
shape of the boundary (or the <code class="docutils literal"><span class="pre">neighborhood</span></code> stencil decorator
argument is used for this purpose if present).
Then, one <code class="docutils literal"><span class="pre">for</span></code> loop for each dimension of the input array is
added to the stencil function definition.  The range of each
loop is controlled by the stencil kernel size previously computed
so that the boundary of the output image is not modified but instead
left as is.   The body of the innermost <code class="docutils literal"><span class="pre">for</span></code> loop is a single
<code class="docutils literal"><span class="pre">sentinel</span></code> statement that is easily recognized in the IR.
A call to <code class="docutils literal"><span class="pre">exec</span></code> with the text buffer is used to force the
stencil function into existence and an <code class="docutils literal"><span class="pre">eval</span></code> is used to get
access to the corresponding function on which <code class="docutils literal"><span class="pre">run_frontend</span></code> is
used to get the stencil function IR.</p>
<p>Various renaming and relabeling is performed on the stencil function
IR and the kernel IR so that the two can be combined without conflict.
The relative indices in the kernel IR (i.e., <code class="docutils literal"><span class="pre">getitem</span></code> calls) are
replaced with expressions where the corresponding loop index variables
are added to the relative indices.  The <code class="docutils literal"><span class="pre">return</span></code> statement in the
kernel IR is replaced with a <code class="docutils literal"><span class="pre">setitem</span></code> for the corresponding element
in the output array.
The stencil function IR is then scanned for the sentinel and the
sentinel replaced with the modified kernel IR.</p>
<p>Next, <code class="docutils literal"><span class="pre">compile_ir</span></code> is used to compile the combined stencil function
IR.  The resulting compile result is cached in the <code class="docutils literal"><span class="pre">StencilFunc</span></code> so that
other calls to the same stencil do not need to undertake this process
again.</p>
</div>
<div class="section" id="exceptions-raised">
<h2>7.9.4. Exceptions raised<a class="headerlink" href="#exceptions-raised" title="Permalink to this headline">¶</a></h2>
<p>Various checks are performed during stencil compilation to make sure
that user-specified options do not conflict with each other or with
other runtime parameters.  For example, if the user has manually
specified a <code class="docutils literal"><span class="pre">neighborhood</span></code> to the stencil decorator, the length of
that neighborhood must match the dimensionality of the input array.
If this is not the case, a <code class="docutils literal"><span class="pre">ValueError</span></code> is raised.</p>
<p>If the neighborhood has not been specified then it must be inferred
and a requirement to infer the kernel is that all indices are constant
integers.  If they are not, a <code class="docutils literal"><span class="pre">ValueError</span></code> is raised indicating that
kernel indices may not be non-constant.</p>
<p>Finally, the stencil implementation detects the output array type
by running Numba type inference on the stencil kernel.  If the
return type of this kernel does not match the type of the value
passed to the <code class="docutils literal"><span class="pre">cval</span></code> stencil decorator option then a <code class="docutils literal"><span class="pre">ValueError</span></code>
is raised.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012, Anaconda, Inc..<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>